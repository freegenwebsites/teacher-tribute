<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Modern Illustrated Tribute Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind CSS via CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome via jsdelivr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">
  <!-- Google Fonts: Indie Flower, Quicksand & Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Quicksand:wght@400;500;700&family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Quicksand', 'Poppins', sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #f0f9ff 0%, #e6fffa 100%);
      color: #3a506b;
    }
    
    /* Card base style with soft gradient */
    .tribute-card {
      position: relative;
      background: linear-gradient(145deg, #ffffff 0%, #f7fbff 100%);
      box-shadow: 0 6px 28px rgba(149, 157, 165, 0.15);
      border-radius: 1.6rem;
      padding: 1.8rem 1.6rem 1.2rem 1.6rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      margin-bottom: 1rem;
      min-height: 325px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid rgba(232, 240, 254, 0.8);
    }
    
    .tribute-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 14px 34px rgba(149, 157, 165, 0.2);
    }
    
    /* Fan gallery style for photos */
    .fan-stack {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      min-height: 120px;
      width: 180px;
      position: relative;
      margin: 0 auto 1.2rem auto;
    }
    
    .fan-img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 1.1rem;
      box-shadow: 0 8px 20px rgba(149, 157, 165, 0.18);
      transform-origin: 50% 80%;
      position: absolute;
      cursor: pointer;
      border: 3px solid #ffffff;
      z-index: 1;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .fan-img:hover {
      z-index: 10;
      transform: scale(1.1) translateY(-10px);
    }
    
    /* Illustration placeholder for cards without photos */
    .teacher-illustration {
      width: 120px;
      height: 120px;
      border-radius: 30%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden;
      background-size: cover;
      background-position: center;
    }
    
    /* Themed illustration backgrounds with soft gradients */
    .illustration-bg-1 {
      background: linear-gradient(145deg, #dbf4ff 0%, #bbdeff 100%);
    }
    
    .illustration-bg-2 {
      background: linear-gradient(145deg, #e6f8e6 0%, #c2f0c2 100%);
    }
    
    .illustration-bg-3 {
      background: linear-gradient(145deg, #fff0e0 0%, #ffd8b5 100%);
    }
    
    .illustration-bg-4 {
      background: linear-gradient(145deg, #f0e6ff 0%, #dac2f0 100%);
    }
    
    .illustration-bg-5 {
      background: linear-gradient(145deg, #ffe6ec 0%, #ffccd6 100%);
    }
    
    /* Themed icons for illustrations */
    .teacher-icon {
      font-size: 3rem;
      color: rgba(255, 255, 255, 0.9);
      text-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    /* Floating celebration elements */
    .floating-celebrate {
      position: absolute;
      font-size: 1.25rem;
      opacity: 0.15;
      pointer-events: none;
      animation: floatCelebrate 10s linear infinite;
      z-index: 0;
    }
    
    @keyframes floatCelebrate {
      0% {transform: translateY(50px) scale(1.1) rotate(0deg);}
      50% {transform: translateY(-120px) scale(1) rotate(10deg);}
      100% {transform: translateY(-250px) scale(0.9) rotate(0deg); opacity: 0;}
    }
    
    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {width: 6px;}
    .custom-scrollbar::-webkit-scrollbar-thumb {background: #c7d2fe; border-radius: 10px;}
    .custom-scrollbar::-webkit-scrollbar-track {background: #f1f5f9;}
    
    /* Form styling */
    .tribute-form {
      background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid rgba(226, 232, 240, 0.8);
    }
    
    /* Unique for PDF optimization */
    @media print {
      body { 
        width: 100%; 
        margin: 0; 
        padding: 0;
      }
      .custom-scrollbar {
        overflow: visible !important;
      }
    }
    
    /* Modal styling */
    .modal-container {
      backdrop-filter: blur(5px);
    }
    
    .modal-content {
      border: 1px solid rgba(226, 232, 240, 0.8);
    }
    
    /* Footer decoration */
    .footer-decoration {
      background: linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(225, 239, 254, 0.6) 100%);
      height: 120px;
      position: relative;
      overflow: visible;
    }
    
    /* Confetti animation for success */
    @keyframes confetti-fall {
      0% {transform: translateY(-80px) rotate(0deg);}
      100% {transform: translateY(400px) rotate(90deg); opacity: 0;}
    }
    
    .confetti-particle {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: confetti-fall 3s forwards ease-out;
    }
    
    /* Card illustrations with SVG patterns */
    .card-pattern-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.04;
      pointer-events: none;
      background-size: 180px 180px;
      border-radius: 1.6rem;
    }
    
    .pattern-dots {
      background-image: radial-gradient(#3b82f6 8%, transparent 8%);
      background-position: 0 0;
      background-size: 20px 20px;
    }
    
    .pattern-lines {
      background-image: linear-gradient(45deg, #3b82f6 25%, transparent 25%, transparent 50%, #3b82f6 50%, #3b82f6 75%, transparent 75%, transparent);
      background-size: 10px 10px;
    }
    
    .pattern-waves {
      background: repeating-radial-gradient(
        circle at 50%,
        rgba(59, 130, 246, 0),
        rgba(59, 130, 246, 0) 10px,
        rgba(59, 130, 246, 0.1) 10px,
        rgba(59, 130, 246, 0.1) 20px
      );
    }
    
    /* Progress bar animation for form submission */
    @keyframes progress-fill {
      0% { width: 0%; }
      100% { width: 100%; }
    }
    
    .progress-animation {
      animation: progress-fill 2s ease-out;
    }
  </style>
</head>
<body class="pb-16">
  <!-- Floating celebration elements -->
  <span class="floating-celebrate left-12 top-28" style="animation-delay:0.1s; color:#60a5fa;"><i class="fa-solid fa-book"></i></span>
  <span class="floating-celebrate left-1/4 top-56" style="animation-delay:1.6s; color:#f59e0b;"><i class="fa-solid fa-apple-whole"></i></span>
  <span class="floating-celebrate right-14 top-28" style="animation-delay:0.9s; color:#34d399;"><i class="fa-solid fa-seedling"></i></span>
  <span class="floating-celebrate left-1/3 top-44" style="animation-delay:2.1s; color:#8b5cf6;"><i class="fa-solid fa-award"></i></span>
  <span class="floating-celebrate right-1/4 top-56" style="animation-delay:1.2s; color:#ec4899;"><i class="fa-solid fa-graduation-cap"></i></span>
  <span class="floating-celebrate left-3/5 top-96" style="animation-delay:2.36s; color:#10b981;"><i class="fa-solid fa-pencil"></i></span>
  <span class="floating-celebrate left-2/3 top-20" style="animation-delay:0.5s; color:#fbbf24;"><i class="fa-solid fa-bell-school"></i></span>

  <div class="max-w-5xl mx-auto mt-12 px-4">
    <!-- Title & Description -->
    <div class="text-center mb-10">
      <h1 class="mb-3" style="font-family:'Indie Flower',cursive;font-size:2.5rem;color:#3b82f6;text-shadow:0 2px 10px rgba(59, 130, 246, 0.15);letter-spacing:1.2px;">
        ðŸŒŸ Happy Retirement, Teacher!
      </h1>
      <p style="font-family:'Quicksand',sans-serif;color:#475569;font-size:1.15rem;max-width:700px;margin:0 auto;">
        The influence of a great teacher stays with us forever. Share your memories, gratitude, and well-wishes below.
      </p>
      <div class="flex justify-center mt-4">
        <div class="h-1 w-24 bg-gradient-to-r from-blue-300 to-blue-500 rounded-full"></div>
      </div>
    </div>

    <!-- Add/Edit Tribute Form -->
    <form id="tributeForm" class="mb-12 tribute-form rounded-2xl py-6 px-5 shadow-lg">
      <input type="hidden" id="editIndex" value="">
      
      <div class="flex flex-wrap -mx-2">
        <div class="w-full md:w-1/4 px-2 mb-4">
          <label for="fromName" class="block text-blue-600 font-semibold mb-2">Your Name</label>
          <input id="fromName" name="fromName" type="text" class="w-full rounded-xl border border-blue-100 px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-blue-300 focus:outline-none transition duration-200" maxlength="32" required placeholder="E.g. Jamie">
        </div>
        
        <div class="w-full md:w-1/2 px-2 mb-4">
          <label for="message" class="block text-blue-600 font-semibold mb-2">Your Message</label>
          <textarea id="message" name="message" rows="2" class="w-full rounded-xl border border-blue-100 px-3 py-2 focus:ring-2 focus:ring-blue-200 focus:border-blue-300 focus:outline-none transition duration-200" maxlength="220" required placeholder="Share your favorite memory or wish..."></textarea>
        </div>
        
        <div class="w-full md:w-1/4 px-2 mb-4">
          <label for="photos" class="block text-blue-600 font-semibold mb-2">
            Photos <span class="text-xs font-normal text-gray-400">(optional, up to 4)</span>
          </label>
          <input id="photos" name="photos" type="file" multiple accept="image/*" class="w-full border rounded-xl py-2 px-2 text-sm bg-blue-50 border-blue-100">
        </div>
      </div>
      
      <div class="flex justify-end mt-2">
        <button id="cancelEditBtn" class="hidden px-5 py-2 mr-3 rounded-xl bg-gray-100 text-gray-600 font-medium hover:bg-gray-200 focus:outline-none transition duration-200" type="button">
          Cancel
        </button>
        <button id="submitBtn" type="submit" class="bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-bold py-2 px-6 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-300 transition duration-200 transform active:scale-95 shadow-md">
          <i class="fa-solid fa-paper-plane mr-1"></i>
          <span id="submitBtnText">Share</span>
        </button>
      </div>
    </form>

    <!-- Tribute Cards Grid -->
    <div id="tributesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    
    <!-- Empty State -->
    <div id="emptyState" class="text-center text-blue-300 italic mt-16 mb-10 text-lg hidden">
      <div class="mx-auto w-24 h-24 mb-6">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full text-blue-200">
          <path d="M20 12V8H4V12M20 12V16H4V12M20 12H4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          <path d="M8 18H16M12 4V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </div>
      <p>No tributes yet. Be the first to share your appreciation!</p>
    </div>
  </div>
  
  <!-- Modal for single photo view -->
  <div id="galleryModal" class="fixed inset-0 bg-black bg-opacity-40 modal-container z-50 hidden flex items-center justify-center">
    <div class="absolute inset-0 cursor-pointer" id="modalBG"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 flex flex-col items-center px-4 py-6 border modal-content">
      <button type="button" id="closeModalBtn" class="absolute right-3 top-3 text-2xl text-gray-400 hover:text-gray-600 focus:outline-none z-10" title="Close">
        <i class="fa-solid fa-xmark"></i>
      </button>
      
      <div class="w-full flex items-center justify-center mb-4">
        <button type="button" id="prevImgBtn" class="text-xl text-blue-400 hover:text-blue-600 px-3 focus:outline-none hidden">
          <i class="fa-solid fa-chevron-left"></i>
        </button>
        <div id="modalImgContainer" class="max-w-lg rounded-xl overflow-hidden bg-gray-50 shadow">
          <img id="modalImg" src="" alt="Gallery Image" class="object-contain mx-auto" style="max-height:60vh;">
        </div>
        <button type="button" id="nextImgBtn" class="text-xl text-blue-400 hover:text-blue-600 px-3 focus:outline-none hidden">
          <i class="fa-solid fa-chevron-right"></i>
        </button>
      </div>
      
      <div id="galleryCaption" class="text-center text-sm mt-2 text-gray-500"></div>
    </div>
  </div>

  <!-- Footer with decoration -->
  <footer class="w-full text-center mt-16 pt-8 pb-6 relative">
    <div class="footer-decoration absolute inset-x-0 top-0 -z-10"></div>
    
    <div class="max-w-md mx-auto px-4">
      <div class="flex justify-center mb-4">
        <div class="w-14 h-14 rounded-full bg-blue-50 flex items-center justify-center">
          <i class="fa-solid fa-award text-2xl text-blue-400"></i>
        </div>
      </div>
      
      <p class="text-xl mb-2" style="font-family:'Indie Flower', cursive; color:#3b82f6;">
        Wishing you joy in your next chapter!
      </p>
      
      <p class="text-gray-500 text-sm">
        Made with appreciation by everyone whose lives you've touched.
      </p>
    </div>
  </footer>

  <!-- Progress indicator (hidden by default) -->
  <div id="progressIndicator" class="fixed bottom-0 left-0 w-full h-1 bg-gray-200 hidden">
    <div class="h-full bg-gradient-to-r from-blue-400 to-indigo-500 progress-animation"></div>
  </div>

<script>
  // --- STATE ---
  let tributes = [];
  let editingTributeId = null;
  
  // --- THEMED ILLUSTRATIONS ---
  // Icons for cards without photos
  const THEMED_ICONS = [
    { icon: 'fa-graduation-cap', bg: 'illustration-bg-1' },
    { icon: 'fa-book', bg: 'illustration-bg-2' },
    { icon: 'fa-apple-whole', bg: 'illustration-bg-3' },
    { icon: 'fa-award', bg: 'illustration-bg-4' },
    { icon: 'fa-pencil', bg: 'illustration-bg-5' },
    { icon: 'fa-heart', bg: 'illustration-bg-1' },
  ];
  
  // Card patterns for visual interest
  const CARD_PATTERNS = [
    'pattern-dots',
    'pattern-lines',
    'pattern-waves'
  ];

  // --- UTILS ---
  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[s]));
  }
  
  function formatDateString(dbDateString) {
    if (!dbDateString || typeof dbDateString !== 'string') return '';
    try {
      const isoFriendlyString = dbDateString.replace(' ', 'T');
      const date = new Date(isoFriendlyString);
      if (isNaN(date.getTime())) return 'Invalid date';
      return date.toLocaleDateString("en-US", { month: 'short', day: 'numeric', year: 'numeric' });
    } catch (e) {
      return '';
    }
  }
  
  function getRandomItem(array) {
    return array[Math.floor(Math.random() * array.length)];
  }
  
  async function filesToDataURLs(fileList) {
    const dataURLs = [];
    const filesToProcess = Array.from(fileList).slice(0, 4);
    
    const readerPromises = filesToProcess.map(file => {
      return new Promise((resolve, reject) => {
        if (!file.type.startsWith('image/')) {
          console.warn(`Skipping non-image file: ${file.name}`);
          return resolve(null);
        }
        
        if (file.size > 5 * 1024 * 1024) {
          console.warn(`Skipping large file (>5MB): ${file.name}`);
          return resolve(null);
        }
        
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
      });
    });
    
    const results = await Promise.all(readerPromises);
    return results.filter(url => url !== null);
  }

  // --- RENDERING ---
  function renderAllTributes() {
    const grid = document.getElementById("tributesGrid");
    const emptyState = document.getElementById('emptyState');
    
    grid.innerHTML = "";
    
    if (!tributes || !tributes.length) {
      emptyState.classList.remove('hidden');
      return;
    }
    
    emptyState.classList.add('hidden');
    tributes.forEach((tribute, idx) => {
      grid.innerHTML += renderTributeCard(tribute, idx);
    });
    
    attachCardEventListeners();
  }
  
  function renderTeacherIllustration(tribute, index) {
    // Select a themed icon based on the tribute or index
    const nameHash = tribute.from ? tribute.from.charCodeAt(0) : index;
    const iconIndex = nameHash % THEMED_ICONS.length;
    const theme = THEMED_ICONS[iconIndex];
    
    return `
      <div class="teacher-illustration ${theme.bg} flex items-center justify-center">
        <i class="fa-solid ${theme.icon} teacher-icon"></i>
      </div>
    `;
  }
  
  function renderFanGallery(tribute, tributeIdx) {
    const photoArray = Array.isArray(tribute.photos) ? tribute.photos : [];
    
    if (!photoArray.length) {
      // If no photos, render a themed illustration
      return renderTeacherIllustration(tribute, tributeIdx);
    }
    
    // Otherwise render the fan gallery of photos
    let imgMarkup = "";
    let n = Math.min(photoArray.length, 4);
    let spread = (n === 1) ? [0] : (n === 2) ? [-12, 12] : (n === 3) ? [-16, 0, 16] : [-20, -7, 7, 20];
    
    for (let i = 0; i < n; i++) {
      if (typeof photoArray[i] !== 'string' || !photoArray[i]) continue;
      
      let ang = spread[i];
      let depth = n - i;
      
      imgMarkup += `<img
        src="${escapeHtml(photoArray[i])}"
        class="fan-img"
        data-tidx="${tributeIdx}"
        data-pidx="${i}"
        tabindex="0"
        style="transform:rotate(${ang}deg); z-index:${depth};"
        alt="Memory photo ${i + 1}"
      >`;
    }
    
    return `<div class="fan-stack">${imgMarkup}</div>`;
  }
  
  function renderTributeCard(tribute, idx) {
    const pattern = CARD_PATTERNS[idx % CARD_PATTERNS.length];
    const tributeId = tribute.id;
    
    return `
      <div class="tribute-card relative overflow-hidden" data-cardidx="${idx}" data-id="${tributeId}">
        <div class="card-pattern-overlay ${pattern}"></div>
        <div class="absolute right-3 top-3 flex space-x-2 z-10 opacity-70 hover:opacity-100 transition-all">
          <button title="Edit" data-act="edit" data-id="${tributeId}" class="text-blue-500 hover:text-amber-500 bg-white rounded-full shadow-sm border border-blue-50 w-8 h-8 flex items-center justify-center focus:outline-none transition">
            <i class="fa-solid fa-pen text-sm"></i>
          </button>
          <button title="Delete" data-act="delete" data-id="${tributeId}" class="text-blue-500 hover:text-rose-500 bg-white rounded-full shadow-sm border border-blue-50 w-8 h-8 flex items-center justify-center focus:outline-none transition">
            <i class="fa-solid fa-trash text-sm"></i>
          </button>
        </div>
        
        ${renderFanGallery(tribute, idx)}
        
        <div class="text-blue-600 font-bold mb-2 text-center" style="font-family:'Quicksand',sans-serif">
          ${escapeHtml(tribute.from || "Anonymous")}
        </div>
        
        <div class="text-gray-700 mb-6 text-center" style="font-family:'Indie Flower',cursive;font-size:1.15rem;line-height:1.4;">
          ${escapeHtml(tribute.msg || '').replace(/\n/g, "<br>")}
        </div>
        
        <div class="text-xs text-blue-400 absolute bottom-3 left-1/2 transform -translate-x-1/2 flex items-center gap-2">
          <i class="fa-solid fa-calendar-heart"></i>
          <span>${formatDateString(tribute.date) || ''}</span>
        </div>
      </div>
    `;
  }

  // --- API INTERACTIONS ---
  async function fetchAndRenderTributes() {
    const grid = document.getElementById("tributesGrid");
    const emptyState = document.getElementById('emptyState');
    
    grid.innerHTML = `
      <div class="col-span-full flex justify-center py-10">
        <div class="animate-pulse flex flex-col items-center">
          <div class="rounded-full bg-blue-200 h-14 w-14 mb-4 flex items-center justify-center">
            <i class="fa-solid fa-hourglass text-blue-300 text-xl"></i>
          </div>
          <p class="text-blue-300">Loading tributes...</p>
        </div>
      </div>
    `;
    
    emptyState.classList.add('hidden');
    
    try {
      const response = await fetch('/.netlify/functions/get-tributes');
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      tributes = await response.json();
      renderAllTributes();
    } catch (error) {
      console.error("Failed to fetch tributes:", error);
      
      grid.innerHTML = `
        <div class="col-span-full text-center py-10">
          <div class="mx-auto w-14 h-14 rounded-full bg-red-50 flex items-center justify-center mb-3">
            <i class="fa-solid fa-triangle-exclamation text-red-400 text-xl"></i>
          </div>
          <p class="text-red-400 mb-2">Could not load tributes</p>
          <p class="text-gray-500 text-sm">Please check your connection or try again later</p>
        </div>
      `;
      
      emptyState.classList.add('hidden');
    }
  }
  
  async function submitTribute(tributeData, idToUpdate = null) {
    const isUpdating = idToUpdate !== null;
    const endpoint = isUpdating ? '/.netlify/functions/update-tribute' : '/.netlify/functions/add-tribute';
    const method = isUpdating ? 'PUT' : 'POST';
    const payload = isUpdating ? { ...tributeData, id: idToUpdate } : tributeData;
    
    // Show progress indicator
    document.getElementById('progressIndicator').classList.remove('hidden');
    
    try {
      const response = await fetch(endpoint, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        let errorMsg = `HTTP error! status: ${response.status}`;
        try {
          const errorData = await response.json();
          errorMsg = errorData.error || errorMsg;
        } catch (e) { /* Ignore parsing errors */ }
        
        throw new Error(errorMsg);
      }
      
      // On success, show confetti effect
      if (!isUpdating) {
        showConfetti();
      }
      
      await fetchAndRenderTributes();
      return true;
    } catch (error) {
      console.error(`Failed to ${isUpdating ? 'update' : 'add'} tribute:`, error);
      alert(`Error ${isUpdating ? 'updating' : 'sharing'} tribute: ${error.message}`);
      return false;
    } finally {
      // Hide progress indicator
      setTimeout(() => {
        document.getElementById('progressIndicator').classList.add('hidden');
      }, 200);
    }
  }
  
  async function deleteTribute(tributeId) {
    const idToDelete = parseInt(tributeId, 10);
    if (isNaN(idToDelete)) return false;
    
    if (!confirm('Are you sure you want to delete this tribute? This cannot be undone.')) {
      return false;
    }
    
    // Show progress indicator
    document.getElementById('progressIndicator').classList.remove('hidden');
    
    try {
      const response = await fetch('/.netlify/functions/delete-tribute', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: idToDelete })
      });
      
      if (!response.ok) {
        let errorMsg = `HTTP error! status: ${response.status}`;
        try {
          const errorData = await response.json();
          errorMsg = errorData.error || errorMsg;
        } catch (e) { /* Ignore parsing errors */ }
        
        throw new Error(errorMsg);
      }
      
      await fetchAndRenderTributes();
      return true;
    } catch (error) {
      console.error("Failed to delete tribute:", error);
      alert(`Error deleting tribute: ${error.message}`);
      return false;
    } finally {
      // Hide progress indicator
      setTimeout(() => {
        document.getElementById('progressIndicator').classList.add('hidden');
      }, 200);
    }
  }

  // --- FORM LOGIC ---
  async function handleFormSubmit(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const submitBtnText = document.getElementById('submitBtnText');
    const fileInput = document.getElementById('photos');
    
    // Disable button immediately
    submitBtn.disabled = true;
    
    // Set loading text based on edit state
    const originalBtnText = editingTributeId ? "Update" : "Share";
    submitBtnText.textContent = editingTributeId ? 'Updating...' : 'Sharing...';
    
    // Show a "processing" message if files are selected
    if (fileInput.files.length > 0) {
      submitBtnText.textContent = editingTributeId ? 'Processing images...' : 'Processing images...';
    }
    
    let photos = [];
    
    try {
      // Process any selected files
      if (fileInput.files.length > 0) {
        photos = await filesToDataURLs(fileInput.files);
      }
      
      // Get other form data
      const from = document.getElementById('fromName').value.trim() || "Anonymous";
      const msg = document.getElementById('message').value.trim();
      
      if (!msg) {
        throw new Error("Please enter a message.");
      }
      
      // Create the data payload
      const tributeData = { from, msg, photos };
      
      // Get the ID to update (will be null if adding)
      const idToUpdate = editingTributeId ? parseInt(editingTributeId, 10) : null;
      if (editingTributeId && isNaN(idToUpdate)) {
        throw new Error("Invalid tribute ID for update.");
      }
      
      // Submit the tribute
      const success = await submitTribute(tributeData, idToUpdate);
      
      if (success) {
        resetForm(); // Reset form only on success
      } else {
        // Re-enable the button on failure
        submitBtn.disabled = false;
        submitBtnText.textContent = originalBtnText;
      }
    } catch (error) {
      // Show error and re-enable button
      console.error("Error during form submission:", error);
      alert(error.message || "An error occurred while processing your tribute. Please try again.");
      
      submitBtn.disabled = false;
      submitBtnText.textContent = originalBtnText;
    }
  }
  
  function resetForm() {
    document.getElementById('tributeForm').reset();
    document.getElementById('submitBtnText').textContent = "Share";
    document.getElementById('cancelEditBtn').classList.add('hidden');
    editingTributeId = null;
    document.getElementById('submitBtn').disabled = false;
  }
  
  function loadEditForm(tributeId) {
    const tributeIdAsNumber = parseInt(tributeId, 10);
    if (isNaN(tributeIdAsNumber)) return;
    
    const tributeToEdit = tributes.find(t => t.id === tributeIdAsNumber);
    
    if (!tributeToEdit) {
      console.error("Could not find tribute with ID:", tributeIdAsNumber);
      alert("Could not load tribute for editing.");
      return;
    }
    
    document.getElementById('fromName').value = tributeToEdit.from || '';
    document.getElementById('message').value = tributeToEdit.msg || '';
    
    editingTributeId = tributeIdAsNumber;
    document.getElementById('submitBtnText').textContent = "Update";
    document.getElementById('cancelEditBtn').classList.remove('hidden');
    
    // Smooth scroll to form
    window.scrollTo({
      top: document.getElementById('tributeForm').offsetTop - 100,
      behavior: 'smooth'
    });
  }

  // --- CARD BUTTONS / IMAGE EVENTS ---
  function attachCardEventListeners() {
    const grid = document.getElementById('tributesGrid');
    if (!grid) return;
    
    // Use event delegation for all card interactions
    grid.addEventListener('click', function(event) {
      const target = event.target;
      
      // Handle button clicks
      const button = target.closest('button[data-act]');
      if (button) {
        event.stopPropagation();
        const action = button.getAttribute('data-act');
        const id = button.getAttribute('data-id');
        
        if (!id) return;
        
        if (action === 'edit') {
          loadEditForm(id);
        } else if (action === 'delete') {
          deleteTribute(id);
        }
        return;
      }
      
      // Handle photo clicks
      const img = target.closest('.fan-img');
      if (img) {
        event.stopPropagation();
        const tIdx = parseInt(img.getAttribute("data-tidx"));
        const pIdx = parseInt(img.getAttribute("data-pidx"));
        
        if (!isNaN(tIdx) && !isNaN(pIdx) && tributes[tIdx]) {
          showModalGallery(tIdx, pIdx);
        }
      }
    });
    
    // Add keyboard accessibility for images
    document.querySelectorAll('.fan-img').forEach(img => {
      img.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          img.click();
        }
      });
    });
  }

  // --- MODAL GALLERY LOGIC ---
  let modalTributeIdx = 0, modalPhotoIdx = 0;
  
  function showModalGallery(tributeIdx, photoIdx) {
    if (!tributes[tributeIdx]) return;
    
    modalTributeIdx = tributeIdx;
    modalPhotoIdx = photoIdx;
    renderModalImage();
    
    document.getElementById("galleryModal").classList.remove("hidden");
    document.body.style.overflow = 'hidden';
  }
  
  function renderModalImage() {
    let tribute = tributes[modalTributeIdx];
    let photos = Array.isArray(tribute.photos) ? tribute.photos : [];
    let currentPhotoSrc = photos[modalPhotoIdx];
    
    if (typeof currentPhotoSrc !== 'string' || !currentPhotoSrc) {
      closeModalGallery();
      return;
    }
    
    document.getElementById('modalImg').src = currentPhotoSrc;
    document.getElementById('galleryCaption').textContent = 
      `${tribute.from || "Anonymous"} - Photo ${modalPhotoIdx + 1} of ${photos.length}`;
    
    // Show/hide navigation buttons
    document.getElementById('prevImgBtn').classList.toggle('hidden', modalPhotoIdx === 0);
    document.getElementById('nextImgBtn').classList.toggle('hidden', modalPhotoIdx >= photos.length - 1);
  }
  
  function closeModalGallery() {
    document.getElementById("galleryModal").classList.add("hidden");
    document.getElementById('modalImg').src = '';
    document.body.style.overflow = '';
  }

  // --- VISUAL EFFECTS ---
  function showConfetti() {
    // Create confetti container if not exists
    let confettiContainer = document.querySelector('.confetti-container');
    
    if (!confettiContainer) {
      confettiContainer = document.createElement('div');
      confettiContainer.className = 'fixed inset-0 pointer-events-none z-50';
      document.body.appendChild(confettiContainer);
    }
    
    confettiContainer.innerHTML = '';
    
    // Generate random confetti particles
    const colors = ['#60a5fa', '#34d399', '#fbbf24', '#f87171', '#a78bfa', '#f472b6'];
    const count = 60;
    
    for (let i = 0; i < count; i++) {
      const particle = document.createElement('div');
      
      particle.className = 'confetti-particle';
      particle.style.left = Math.random() * 100 + 'vw';
      particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      particle.style.opacity = (0.6 + Math.random() * 0.4).toString();
      particle.style.width = (5 + Math.random() * 7) + 'px';
      particle.style.height = (5 + Math.random() * 7) + 'px';
      particle.style.animationDuration = (2 + Math.random() * 2) + 's';
      particle.style.animationDelay = (Math.random() * 0.5) + 's';
      
      confettiContainer.appendChild(particle);
    }
    
    // Clean up after animation completes
    setTimeout(() => {
      confettiContainer.innerHTML = '';
    }, 4000);
  }

  // --- INITIALIZE & EVENT LISTENERS ---
  document.addEventListener("DOMContentLoaded", function() {
    fetchAndRenderTributes();
    
    // Set up form event listeners
    document.getElementById('tributeForm').addEventListener('submit', handleFormSubmit);
    document.getElementById('cancelEditBtn').addEventListener('click', resetForm);
    
    // Set up modal event listeners
    document.getElementById('closeModalBtn').addEventListener('click', closeModalGallery);
    document.getElementById('modalBG').addEventListener('click', closeModalGallery);
    
    document.getElementById('prevImgBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      if (modalPhotoIdx > 0) {
        modalPhotoIdx--;
        renderModalImage();
      }
    });
    
    document.getElementById('nextImgBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      const photos = Array.isArray(tributes[modalTributeIdx].photos) ? tributes[modalTributeIdx].photos : [];
      if (modalPhotoIdx < photos.length - 1) {
        modalPhotoIdx++;
        renderModalImage();
      }
    });
    
    // Keyboard shortcuts for modal
    window.addEventListener("keydown", function(e) {
      const modal = document.getElementById("galleryModal");
      if (modal.classList.contains("hidden")) return;
      
      if (e.key === "ArrowLeft") {
        document.getElementById('prevImgBtn').click();
      } else if (e.key === "ArrowRight") {
        document.getElementById('nextImgBtn').click();
      } else if (e.key === "Escape") {
        closeModalGallery();
      }
    });
  });
</script>
</body>
</html>



