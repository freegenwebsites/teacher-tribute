<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Retiring Teacher Tribute Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Create a tribute board for a retiring teacher with hover animations, fan-like stacking image gallery, and mobile-friendly features">
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">
  <!-- Google Fonts: Indie Flower (cute headlines), Quicksand (body) -->
  <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(120deg, #f9ecff 0%, #e9e1ff 100%);
      font-family: 'Quicksand', 'Indie Flower', cursive, sans-serif;
      min-height: 100vh;
    }
    .card-animated {
      transition:
        transform 0.21s cubic-bezier(.34,1.56,.64,1),
        box-shadow 0.22s;
      will-change: transform, box-shadow;
      background: linear-gradient(135deg,#fcf3ff 70%, #e6d5f7 100%);
      position: relative; /* Needed for absolute positioning of buttons */
      overflow: visible; /* Ensure buttons aren't clipped */
    }
    .card-animated:hover, .card-animated.mobile-anim {
      transform: translateY(-8px) scale(1.045) rotate(-1.5deg);
      box-shadow: 0 15px 44px rgba(200,138,255,.18), 0 1.5px 8px rgba(122,122,216,.13);
      z-index:10;
    }
    /* Style for edit/remove buttons */
    .card-actions {
        position: absolute;
        top: 6px;
        right: 6px;
        display: flex;
        gap: 4px;
        opacity: 0; /* Hide by default */
        transition: opacity 0.2s ease-in-out;
        z-index: 15; /* Above card content */
    }
    .card-animated:hover .card-actions,
    .card-animated:focus-within .card-actions /* Show on focus too */
     {
        opacity: 0.8; /* Show on hover/focus */
    }
    .card-actions button {
        background: rgba(255, 255, 255, 0.7);
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(200, 138, 255, 0.3);
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: all 0.15s ease;
    }
    .card-actions button:hover {
        opacity: 1;
        transform: scale(1.1);
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .edit-btn { color: #6d4fa8; }
    .remove-btn { color: #ec4899; }
    /* --- End Edit/Remove Button Styles --- */

    .tribute-title {
      font-family: 'Indie Flower', cursive;
      color: #b366d1;
      text-shadow: 0 2px 7px #fed6f5a5;
      font-size: 2.07rem;
      letter-spacing: 1.5px;
    }
    .tribute-quote {
      font-family: 'Indie Flower', cursive;
      color: #6d4fa8;
      font-size:1.07rem;
      opacity: .9;
      text-align: center;
    }
    .cute-btn {
      background: linear-gradient(90deg, #fccb90 0%, #d57eea 100%);
      transition: background 0.14s, box-shadow 0.14s; /* Added box-shadow transition */
    }
    .cute-btn:hover {
      background: linear-gradient(90deg, #fcb6c0 0%, #a16ae8 100%);
      box-shadow: 0 4px 12px rgba(200, 138, 255, 0.2); /* Added hover shadow */
    }
    .floating-heart {
      position: absolute;
      font-size: 1.23rem;
      opacity: 0.15;
      pointer-events:none;
      animation: floatHeart 10s linear infinite;
      z-index: 0;
    }
    @keyframes floatHeart {
      0% {transform: translateY(50px) scale(1.09);}
      100% {transform: translateY(-200px) scale(1);}
    }
    .fan-gallery {
      position: relative;
      height:126px;
      width:156px;
      margin:0 auto 0.8rem auto;
      display:flex;
      align-items: flex-end;
      justify-content: center;
      z-index:4;
      pointer-events: none; /* Allow clicks to pass through to images */
    }
    .fan-img {
      position: absolute;
      left:50%; bottom:0;
      width:105px;height:120px;
      object-fit:cover;
      object-position: center top;
      border-radius: 13px;
      box-shadow: 0 2px 12px 0 rgba(156,108,200,0.14);
      background: #faf7ff;
      border: 2px solid #f3deff;
      cursor:pointer;
      pointer-events:auto; /* Make images clickable */
      opacity:.93;
      transition:
        box-shadow 0.22s cubic-bezier(.34,1.56,.64,1),
        transform .23s cubic-bezier(.4,1.8,.6,.75),
        z-index .22s,
        filter .14s;
      will-change: transform, box-shadow, filter;
    }
    .fan-img:hover, .fan-img:focus {
      box-shadow: 0 8px 24px rgba(199,136,255,0.23);
      filter: brightness(1.08);
      z-index:23!important;
      transform: scale(1.16) rotate(0deg)!important;
    }
    .fan-gallery .fan-img.fan-anim {
      filter: brightness(1.09) drop-shadow(0 0 15px #f9e1ff73);
      transform: scale(1.14) rotate(0deg)!important;
      z-index:30!important;
    }
    /* Scrollbar styling */
    ::-webkit-scrollbar { width:8px;}
    ::-webkit-scrollbar-thumb { background: #e5d0fd; border-radius: 10px;}
    ::-webkit-scrollbar-track { background: #f8f0ff;}
    /* Tooltip Styling */
    [data-tooltip] {
      position: relative;
      cursor: pointer;
    }
    [data-tooltip]:hover::after,
    [data-tooltip]:focus::after {
      opacity:1;visibility:visible;
      transition:opacity .15s .3s; /* Added delay */
    }
    [data-tooltip]::after {
      opacity: 0; visibility: hidden;
      position: absolute;
      left: 50%; top: 115%; /* Adjusted position slightly */
      transform: translateX(-50%);
      background: #6d4fa8; /* Changed background */
      color: #ffffff; /* Changed text color */
      font-size: .78rem; /* Slightly smaller */
      font-family: 'Quicksand', sans-serif;
      font-weight: 600;
      padding: 3px 9px; /* Adjusted padding */
      border-radius: 6px; /* Adjusted radius */
      content: attr(data-tooltip);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      white-space:nowrap; /* Keep on one line */
      z-index:111;
    }
    /* Style for edit form elements */
    .edit-input, .edit-textarea {
      border: 1px solid #d1c4e9; /* Softer purple border */
      border-radius: 10px;
      padding: 6px 10px;
      margin-bottom: 8px;
      width: 90%;
      text-align: center;
      font-family: 'Quicksand', sans-serif;
      background-color: rgba(255, 255, 255, 0.8);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .edit-input:focus, .edit-textarea:focus {
        outline: none;
        border-color: #a16ae8;
        box-shadow: 0 0 0 2px rgba(161, 106, 232, 0.2);
    }
    .edit-textarea { resize: none; }
    .edit-actions button {
      font-weight: 600;
      padding: 5px 12px;
      border-radius: 8px;
      transition: background-color 0.2s, transform 0.1s;
    }
     .edit-actions button:active {
       transform: scale(0.96);
     }
     .remove-img-btn {
       position: absolute;
       top: -6px; right: -6px;
       width: 20px; height: 20px;
       line-height: 18px; /* Adjust for centering */
       font-size: 11px;
       border-radius: 50%;
       background: white;
       color: #ec4899;
       border: 1px solid #fbcfe8;
       box-shadow: 0 1px 3px rgba(0,0,0,0.1);
       cursor: pointer;
       display: flex; align-items: center; justify-content: center;
       transition: all 0.15s ease;
     }
    .remove-img-btn:hover {
        background: #ec4899;
        color: white;
        border-color: #ec4899;
        transform: scale(1.1);
    }
  </style>
</head>
<body class="relative min-h-screen pb-14">
  <!-- Cute background hearts -->
  <span class="floating-heart left-10 top-24" style="animation-delay: 0s; color:#f890b4;"><i class="fa-solid fa-heart"></i></span>
  <span class="floating-heart left-1/2 top-14" style="animation-delay:1.7s; color:#dcb8ff;"><i class="fa-solid fa-heart"></i></span>
  <span class="floating-heart right-6 top-32" style="animation-delay:0.5s; color:#fcddec;"><i class="fa-solid fa-heart"></i></span>
  <span class="floating-heart left-1/3 top-36" style="animation-delay:2.2s; color:#fcb6c0;"><i class="fa-solid fa-heart"></i></span>
  <!-- Header -->
  <div class="text-center mt-8">
    <h1 class="tribute-title mb-2">üå∏ Happy Retirement, Teacher!</h1>
    <p class="tribute-quote max-w-2xl mx-auto">
      ‚ÄúA truly great teacher is hard to find, difficult to part with, and impossible to forget.‚Äù<br>
      <span class="text-pink-400 font-semibold">Leave a note or upload your pictures below!</span>
    </p>
  </div>
  <!-- Form -->
  <div class="w-full max-w-4xl mx-auto mt-8 px-2">
    <form id="tributeForm" class="mb-8 p-4 bg-white rounded-2xl shadow flex flex-wrap items-center justify-between border-2 border-purple-50">
      <div class="flex flex-col w-full sm:w-1/4 mb-2 sm:mb-0 sm:pr-2">
        <label for="fromName" class="text-purple-500 font-semibold mb-1 text-sm">Your Name</label>
        <input id="fromName" name="fromName" type="text" class="rounded-xl border border-purple-200 px-3 py-2 focus:ring-2 focus:ring-pink-200 focus:outline-none text-sm" maxlength="32" required autocomplete="off" placeholder="E.g. Jamie">
      </div>
      <div class="flex flex-col w-full sm:w-1/2 sm:px-2 mb-2 sm:mb-0">
        <label for="message" class="text-purple-500 font-semibold mb-1 text-sm">Message</label>
        <textarea id="message" name="message" rows="2" class="rounded-xl border border-purple-200 px-3 py-2 focus:ring-2 focus:ring-pink-200 focus:outline-none text-sm" maxlength="220" required placeholder="Your message..."></textarea>
      </div>
      <div class="flex flex-col w-full sm:w-1/6 sm:pl-2 mb-2 sm:mb-0">
        <label for="photos" class="text-purple-500 font-semibold mb-1 text-sm">Photo(s)
          <span class="text-xs font-normal text-gray-400">(max 4)</span>
        </label>
        <input id="photos" name="photos" type="file" multiple accept="image/*" class="border rounded-xl py-1.5 px-1 text-xs bg-purple-50 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
      </div>
      <div class="w-full sm:w-auto flex items-end justify-start sm:justify-end mt-2 sm:mt-0">
        <button type="submit" class="cute-btn font-bold py-2 px-7 text-white rounded-xl focus:outline-none transition-transform transform active:scale-95 text-sm">
          <i class="fa-solid fa-paper-plane mr-1"></i> Share
        </button>
      </div>
    </form>
    <!-- Cards grid -->
    <div id="tributesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
        <!-- Tributes will be rendered here by JS -->
    </div>
    <div id="emptyState" class="text-center text-purple-300 italic mt-10 text-lg hidden">
      <i class="fa-solid fa-star fa-bounce mr-2"></i>No tributes yet. Be the first to post your message!
    </div>
  </div>
  <!-- Modal for photo gallery -->
  <div id="galleryModal" class="fixed inset-0 bg-black bg-opacity-30 z-50 hidden flex items-center justify-center cursor-pointer transition-opacity duration-200">
    <div class="absolute inset-0" id="modalBG"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-11/12 mx-auto flex flex-col items-center px-2 py-5 border-2 border-purple-100 transition-transform duration-300 ease-out scale-95" id="modalContent">
        <!-- Close button added inside -->
      <button type="button" id="closeModalBtn" class="absolute right-2 top-2 text-2xl text-purple-500 hover:text-pink-400 focus:outline-none z-10" title="Close">
        <i class="fa-solid fa-xmark"></i>
      </button>
      <div class="w-full flex items-center justify-center mb-3">
        <button type="button" id="prevImgBtn" class="text-xl text-purple-300 hover:text-purple-600 px-3 focus:outline-none hidden disabled:opacity-30 disabled:cursor-not-allowed" title="Previous">
          <i class="fa-solid fa-chevron-left"></i>
        </button>
        <!-- Added loading indicator -->
        <div id="modalImgContainer" class="max-w-xs sm:max-w-md md:max-w-lg lg:max-w-xl rounded-xl overflow-hidden bg-gray-100 shadow flex items-center justify-center relative min-h-[200px]">
           <i class="fa-solid fa-spinner fa-spin text-purple-300 text-3xl absolute z-0"></i>
           <img id="modalImg" src="" alt="Gallery Image" class="object-contain mx-auto relative z-10 hidden" style="max-height:65vh;">
        </div>
        <button type="button" id="nextImgBtn" class="text-xl text-purple-300 hover:text-purple-600 px-3 focus:outline-none hidden disabled:opacity-30 disabled:cursor-not-allowed" title="Next">
          <i class="fa-solid fa-chevron-right"></i>
        </button>
      </div>
      <div id="galleryCaption" class="text-center text-xs mt-2 mb-2 text-gray-500 font-medium"></div>
    </div>
  </div>
  <footer class="w-full text-center py-7 mt-10 text-gray-400 text-base">
    <i class="fa-solid fa-cake-candles text-pink-300"></i>
    <span>Made with üíù for an unforgettable teacher's new adventure.</span>
  </footer>
<script>
const starterTributes = [ /* ... Keep your starter tributes here ... */
  {
    from: "Zoe",
    msg: "Thank you for being such a patient and inspiring teacher. Happy retirement!",
    date: "May 17, 2024",
    photos: [
      "https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=facearea&w=320&h=220&facepad=1"
    ]
  },
  {
    from: "Ming",
    msg: "I'll always remember your fun lessons and kind smile. You made school a happy place!",
    date: "May 18, 2024",
    photos: []
  },
  {
    from: "Alicia",
    msg: "Wishing you endless days of gardening and naps. You‚Äôve earned it!",
    date: "May 18, 2024",
    photos: [
      "https://images.unsplash.com/photo-1444065381814-865dc9da92c0?auto=format&fit=facearea&w=320&h=220&facepad=2",
      "https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=facearea&w=320&h=220&facepad=1",
      "https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=facearea&w=320&h=220"
    ]
  }
];

const TRIBUTES_KEY = "teacherTributesV3"; // Changed key slightly to avoid conflicts

function getTributes() {
  const stored = localStorage.getItem(TRIBUTES_KEY);
  if(stored) {
    try { return JSON.parse(stored); } catch { return []; }
  }
  // Only return starter if nothing is stored
  return [...starterTributes];
}
function saveTributes(arr) {
  localStorage.setItem(TRIBUTES_KEY, JSON.stringify(arr));
}
function formatNow() {
  const d = new Date();
  return d.toLocaleDateString("en-US", { month: 'short', day: 'numeric', year: 'numeric' });
}

// *** ADDED from Code A ***
function escapeHtml(str) {
  if (typeof str !== 'string') return '';
  return str.replace(/[&<>"']/g, s => {
    return ({'&': '&', '<': '<', '>': '>', '"': '"', "'": '''})[s]
  });
}
// *** END ADDED ***

let tributes = getTributes();

// Card render helpers
function renderFanGallery(photos, tributeIdx) {
  // ... (Keep your existing renderFanGallery function - it's fine)
  if(!photos || !photos.length) return `
    <div class="w-full flex items-center justify-center mb-4 pt-3">
      <div class="w-16 h-16 flex items-center justify-center text-pink-300 rounded-full bg-pink-50 border-2 border-pink-100 shadow text-3xl">
        <i class="fa-solid fa-flower"></i>
      </div>
    </div>
  `;
  let imgs = '';
  let n=photos.length, fanSpread=28;
  for(let i=0;i<n;i++){
    let rot = n===1?0:(n===2?-10+20*i:(n===3?-12+12*i:(n===4?-12+8*i:((i-n/2)*fanSpread/n))));
    let shift = ((i - (n-1)/2) * 29);
    imgs+=`<img
      src="${photos[i]}"
      data-tidx="${tributeIdx}" data-pidx="${i}"
      class="fan-img transition-all focus:outline-none"
      style="z-index:${10+i};transform:translateX(${shift}px) rotate(${rot}deg);"
      tabindex="0"
      alt="Tribute Photo ${i+1}"
      loading="lazy">`; // Added loading="lazy"
  }
  return `<div class="fan-gallery mb-4">${imgs}</div>`;
}

function renderTributeCard(tribute, idx) {
  const icons=['fa-flower','fa-apple-whole','fa-star','fa-heart','fa-seedling','fa-book'];
  // *** ADDED edit/remove buttons + data-index attribute ***
  return `
    <div class="card-animated rounded-2xl px-5 pt-7 pb-7 flex flex-col items-center min-h-[306px] shadow-lg border border-purple-100" data-index="${idx}" style="margin-bottom:6px;">
       <div class="card-actions">
         <button class="edit-btn" data-tooltip="Edit" aria-label="Edit Tribute"><i class="fa-solid fa-pen-to-square"></i></button>
         <button class="remove-btn" data-tooltip="Delete" aria-label="Delete Tribute"><i class="fa-solid fa-trash"></i></button>
       </div>
      ${renderFanGallery(tribute.photos, idx)}
      <div class="text-purple-600 font-bold mb-1 text-lg" style="font-family: 'Indie Flower', cursive;">${escapeHtml(tribute.from || "Anonymous")}</div>
      <div class="text-gray-700 mb-4 text-center whitespace-pre-line break-words" style="font-family:'Indie Flower',cursive;font-size:1.13rem;">${escapeHtml(tribute.msg)}</div>
      <div class="text-xs text-pink-400 absolute bottom-3 left-1/2 transform -translate-x-1/2 flex items-center gap-1">
        <i class="fa-solid ${icons[idx%icons.length]}"></i>
        <span>${escapeHtml(tribute.date||"")}</span>
      </div>
    </div>
  `;
}
// *** END MODIFICATION ***

function renderAllTributes(scrollToTop = false) { // Default scroll to false
  const grid = document.getElementById("tributesGrid");
  grid.innerHTML = ""; // Clear previous content
  tributes = getTributes(); // Refresh tributes from storage

  if(!tributes.length) {
    document.getElementById('emptyState').classList.remove('hidden');
    return;
  } else {
    document.getElementById('emptyState').classList.add('hidden');
  }

  tributes.forEach((trb, idx) => {
    const cardWrapper = document.createElement('div'); // Create a wrapper div
    cardWrapper.innerHTML = renderTributeCard(trb, idx);
    grid.appendChild(cardWrapper.firstElementChild); // Append the actual card element
  });

  attachFanGalleryListeners();
  attachCardActionListeners(); // *** ADDED: Attach edit/remove listeners ***
  applyMobileHoverSimulation(); // Re-apply mobile hover simulation

  if (scrollToTop) {
      window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

// *** ADDED: Attach listeners for Edit/Remove buttons ***
function attachCardActionListeners() {
    const grid = document.getElementById("tributesGrid");

    grid.addEventListener('click', function(e) {
        const editButton = e.target.closest('.edit-btn');
        const removeButton = e.target.closest('.remove-btn');
        const card = e.target.closest('.card-animated');

        if (!card) return; // Click wasn't inside a card

        const idx = parseInt(card.getAttribute('data-index'));
        if (isNaN(idx)) return; // Should not happen

        if (editButton) {
            e.preventDefault(); // Prevent potential default actions
            startEditCard(idx, card);
        } else if (removeButton) {
            e.preventDefault();
            if (confirm("Are you sure you want to delete this tribute? This cannot be undone.")) {
                tributes.splice(idx, 1);
                saveTributes(tributes);
                renderAllTributes(); // Re-render without the deleted card
            }
        }
    });
}
// *** END ADDED ***


function attachFanGalleryListeners() {
  // ... (Keep your existing attachFanGalleryListeners function)
   document.querySelectorAll('.fan-img').forEach(img => {
    img.onclick = function(e) {
      e.stopPropagation();
      const tIdx = parseInt(img.getAttribute("data-tidx"));
      const pIdx = parseInt(img.getAttribute("data-pidx"));
      if (!isNaN(tIdx) && !isNaN(pIdx)) { // Check if attributes are valid numbers
        showModalGallery(tIdx, pIdx);
      } else {
        console.error("Invalid tribute/photo index on image:", img);
      }
    }
    img.onkeydown = function(e) {
      if(e.key==='Enter'||e.key===' '){ e.preventDefault(); img.click();}
    }
    // Fan-like hover animation for desktop only
    img.onmouseenter = function() {
      if(window.innerWidth > 768){ // Check if not touch device (basic check)
         // Ensure other images in the same gallery lose the anim class
         img.closest('.fan-gallery')?.querySelectorAll('.fan-img').forEach(otherImg => {
             otherImg.classList.remove('fan-anim');
         });
         img.classList.add('fan-anim');
      }
    }
    img.onmouseleave = function() {
      // Check if focus is still within the gallery before removing
      setTimeout(() => {
        const gallery = img.closest('.fan-gallery');
        if (gallery && !gallery.contains(document.activeElement)) {
          img.classList.remove('fan-anim');
        }
      }, 50);
    }
     // Also remove anim on focus out if focus leaves the gallery
    img.onblur = function(e) {
       setTimeout(() => {
         const gallery = img.closest('.fan-gallery');
         if (gallery && !gallery.contains(document.activeElement)) {
           img.classList.remove('fan-anim');
         }
       }, 50);
    }
  });
}

// Renamed function for clarity
function applyMobileHoverSimulation() {
  // Card hover for mobile: trigger animation when in viewport
  if('IntersectionObserver' in window && window.innerWidth <= 768){ // Only run on smaller screens potentially touch devices
    document.querySelectorAll('.card-animated').forEach(card => {
      // Ensure card doesn't already have observer attached
      if (card._observer) card._observer.disconnect();

      let observer = new IntersectionObserver(function(entries){
        entries.forEach(entry => {
          if(entry.isIntersecting){
            card.classList.add('mobile-anim');
            // Optional: Remove after a delay if you only want it to trigger once per scroll-in
            // setTimeout(()=>card.classList.remove('mobile-anim'), 800);
            // Optional: Unobserve after triggering once
            // observer.unobserve(card);
          } else {
            // Remove animation when scrolled out of view
            card.classList.remove('mobile-anim');
          }
        });
      }, {threshold:0.3}); // Adjust threshold as needed
      observer.observe(card);
      card._observer = observer; // Store observer reference on the element
    });
  } else {
     // Clean up mobile animation class if resizing to larger screen
     document.querySelectorAll('.card-animated.mobile-anim').forEach(card => card.classList.remove('mobile-anim'));
     // Disconnect observers if screen is large
      document.querySelectorAll('.card-animated').forEach(card => {
          if (card._observer) {
              card._observer.disconnect();
              delete card._observer;
          }
      });
  }
}


// Add message handling
document.getElementById('tributeForm').onsubmit = function(e){
  e.preventDefault();
  const nameInput = document.getElementById('fromName');
  const msgInput = document.getElementById('message');
  const fileInput = document.getElementById('photos');

  const name = nameInput.value.trim() || "Anonymous";
  const msg = msgInput.value.trim();
  const date = formatNow();
  const files = fileInput.files;
  let photos = [];

  // Basic validation
  if (!msg) {
      alert("Please enter a message.");
      msgInput.focus();
      return;
  }

  // Process files using Object URLs
  if(files.length){
    const MAX_PHOTOS = 4;
    const MAX_SIZE_MB = 5;
    let addedCount = 0;
    for(let i=0; i < files.length && addedCount < MAX_PHOTOS; i++){
      const file = files[i];
      if(file.type.startsWith("image/") && file.size < MAX_SIZE_MB * 1024 * 1024){
        photos.push(URL.createObjectURL(file));
        addedCount++;
      } else if (file.type.startsWith("image/")) {
          alert(`Image "${file.name}" is too large (max ${MAX_SIZE_MB}MB).`);
      }
    }
    if (files.length > MAX_PHOTOS) {
        alert(`You selected ${files.length} photos, but only the first ${MAX_PHOTOS} valid images were added.`);
    }
  }

  tributes.unshift({from: name, msg, date, photos});
  saveTributes(tributes);
  renderAllTributes(); // Re-render the grid
  document.getElementById('tributeForm').reset(); // Reset the form

  // Optional: Scroll to the top to see the new card
  // window.scrollTo({ top: document.getElementById('tributesGrid').offsetTop - 20, behavior: 'smooth' });

  // Cleanup Object URLs after a delay (important to prevent memory leaks)
  if (photos.length > 0) {
      setTimeout(() => {
          photos.forEach(ph => {
              if (ph && ph.startsWith('blob:')) {
                  try { URL.revokeObjectURL(ph); } catch(err){ console.warn("Error revoking Object URL:", err)}
              }
          });
      }, 15000); // Increased delay a bit
  }
};

// *** ADDED: startEditCard function from Code A (adapted) ***
function startEditCard(idx, cardElem) {
  let currentTributes = getTributes(); // Get latest tributes
  let t = currentTributes[idx];
  if (!t) {
      console.error("Tribute not found for index:", idx);
      renderAllTributes(); // Re-render to fix potential state issue
      return;
  }

  // Store original content in case of cancel
  const originalContent = cardElem.innerHTML;

  cardElem.innerHTML = `
    <form class='edit-tribute-form w-full h-full flex flex-col items-center justify-between p-3' autocomplete="off">
      <input type="text" class="edit-input font-bold text-purple-600 text-lg" maxlength="32" value="${escapeHtml(t.from || '')}" placeholder="Name" required>
      <textarea class="edit-textarea text-gray-700 text-sm" maxlength="220" rows="4" placeholder="Message" required>${escapeHtml(t.msg || '')}</textarea>
      <div class='flex justify-center flex-wrap gap-2 my-2'>
        ${t.photos && t.photos.map((ph, i) =>
          `<span class="relative group/img">
            <img src="${ph}" class="inline-block w-14 h-14 object-cover rounded-lg border border-purple-200 shadow-sm">
            <button title="Remove Photo" type="button" class="remove-img-btn" data-phidx="${i}" aria-label="Remove photo ${i+1}"><i class="fa fa-times"></i></button>
          </span>`).join("")}
      </div>
      <label class="w-full text-purple-500 font-medium text-xs my-1 flex items-center justify-center cursor-pointer hover:text-purple-700">
        <i class="fa fa-image mr-1"></i> Add Photo(s) ${t.photos ? '('+(4-t.photos.length)+' left)' : '(max 4)'}
        <input type="file" accept="image/*" class="edit-photo-uploader hidden" multiple ${t.photos && t.photos.length >= 4 ? 'disabled' : ''}>
      </label>
      <div class="edit-actions mt-2 w-full flex justify-center gap-3">
        <button type="submit" class="bg-violet-500 hover:bg-violet-600 text-white">Save</button>
        <button type="button" class="bg-pink-400 hover:bg-pink-500 text-white cancel-edit-btn">Cancel</button>
      </div>
    </form>`;

    // --- Event Listeners for Edit Form ---

    const editForm = cardElem.querySelector('.edit-tribute-form');
    if (!editForm) return; // Should not happen

    // Remove photo in edit mode
    editForm.querySelectorAll('.remove-img-btn').forEach(btn => {
        btn.onclick = function(e) {
            e.preventDefault();
            let phidx = parseInt(btn.getAttribute('data-phidx'));
            if (!isNaN(phidx) && t.photos && t.photos[phidx]) {
                // If it's a blob URL, revoke it immediately
                if (t.photos[phidx].startsWith('blob:')) {
                   try { URL.revokeObjectURL(t.photos[phidx]); } catch(err) { console.warn("Error revoking Object URL on remove:", err)}
                }
                t.photos.splice(phidx, 1);
                // Re-render the edit form with the updated photo list
                startEditCard(idx, cardElem);
            }
        }
    });

    // Add photo (up to 4 in total)
    const photoUploader = editForm.querySelector('.edit-photo-uploader');
    if (photoUploader) {
        photoUploader.onchange = function(e) {
            let files = Array.from(e.target.files);
            const MAX_PHOTOS = 4;
            const MAX_SIZE_MB = 5;
            let currentPhotoCount = t.photos ? t.photos.length : 0;
            let canAdd = MAX_PHOTOS - currentPhotoCount;

            if (canAdd <= 0) return; // Max photos reached

            files.slice(0, canAdd).forEach(f => {
                if (f.type.startsWith('image/') && f.size < MAX_SIZE_MB * 1024 * 1024) {
                    if (!t.photos) t.photos = []; // Initialize if needed
                    t.photos.push(URL.createObjectURL(f));
                } else if (f.type.startsWith('image/')) {
                     alert(`Image "${f.name}" is too large (max ${MAX_SIZE_MB}MB) and was not added.`);
                }
            });
            // Re-render edit form immediately to show new photos/updated count
            startEditCard(idx, cardElem);
        }
    }

    // Cancel Edit
    const cancelBtn = editForm.querySelector('.cancel-edit-btn');
    if (cancelBtn) {
        cancelBtn.onclick = function(e) {
            e.preventDefault();
            // Clean up any newly added blob URLs if cancelled
            const newBlobUrls = Array.from(editForm.querySelectorAll('.edit-tribute-form img[src^="blob:"]')).map(img => img.src);
            // Compare with original photos to find only the newly added ones during this edit session
            const originalUrls = currentTributes[idx]?.photos || [];
            newBlobUrls.forEach(url => {
               if (!originalUrls.includes(url)) {
                   try { URL.revokeObjectURL(url); } catch(err){ console.warn("Error revoking Object URL on cancel:", err)}
               }
            });
            // Restore original card content (might be slightly delayed if re-render happened)
            // Safer to just re-render the whole grid based on saved state
            renderAllTributes();
        }
    }

    // Save Edit
    editForm.onsubmit = function(e) {
        e.preventDefault();
        const newName = editForm.querySelector('.edit-input').value.trim().slice(0, 32);
        const newMsg = editForm.querySelector('.edit-textarea').value.trim().slice(0, 220);

        if (!newMsg) {
            alert("Message cannot be empty.");
            editForm.querySelector('.edit-textarea').focus();
            return;
        }

        // Update the tribute object (t should still reference the object in the tributes array)
        t.from = newName || "Anonymous";
        t.msg = newMsg;
        // Photos array (t.photos) was already updated by remove/add handlers

        saveTributes(currentTributes); // Save the modified array
        renderAllTributes(); // Re-render the entire grid
    }

    // Focus the first input field
    const firstInput = editForm.querySelector('.edit-input');
    if (firstInput) firstInput.focus();
}
// *** END ADDED ***


// Image modal gallery logic
let modalTributeIdx = 0, modalPhotoIdx = 0;

function showModalGallery(tributeIdx, photoIdx) {
  // Ensure indices are valid before proceeding
  tributes = getTributes(); // Refresh in case it changed
  if (tributeIdx < 0 || tributeIdx >= tributes.length || !tributes[tributeIdx].photos || photoIdx < 0 || photoIdx >= tributes[tributeIdx].photos.length) {
      console.error("Invalid indices for modal gallery:", tributeIdx, photoIdx);
      closeModalGallery(); // Close if invalid state
      return;
  }

  modalTributeIdx = tributeIdx;
  modalPhotoIdx = photoIdx;

  const modal = document.getElementById("galleryModal");
  const modalContent = document.getElementById("modalContent");
  modal.classList.remove("hidden");
  document.body.style.overflow='hidden'; // Prevent background scrolling

  // Reset state before showing
  const img = document.getElementById('modalImg');
  const spinner = modal.querySelector('.fa-spinner');
  img.classList.add('hidden'); // Hide image initially
  spinner.classList.remove('hidden'); // Show spinner
  img.src = ''; // Clear previous src

  // Render after modal is visible for transition effect
  requestAnimationFrame(() => {
      modal.style.opacity = '1'; // Fade in background
      modalContent.style.transform = 'scale(1)'; // Scale in content
      renderModalImage(); // Load the actual image content
  });
}

function renderModalImage() {
  tributes = getTributes(); // Ensure we have latest data
  let t = tributes[modalTributeIdx];
  let photos = t?.photos || [];

  if (!photos.length) {
      closeModalGallery();
      return;
  }

  // Boundary checks for photo index
  modalPhotoIdx = Math.max(0, Math.min(modalPhotoIdx, photos.length - 1));

  const img = document.getElementById('modalImg');
  const spinner = document.querySelector('#galleryModal .fa-spinner');
  const caption = document.getElementById('galleryCaption');
  const prevBtn = document.getElementById('prevImgBtn');
  const nextBtn = document.getElementById('nextImgBtn');

  spinner.classList.remove('hidden'); // Show spinner while loading
  img.classList.add('hidden');      // Hide image while loading

  img.onload = () => {
      spinner.classList.add('hidden'); // Hide spinner on load
      img.classList.remove('hidden');   // Show image
  };
  img.onerror = () => {
      spinner.classList.add('hidden'); // Hide spinner on error
      caption.textContent = "Error loading image.";
      img.alt = "Error loading image";
      // Maybe display a placeholder error icon?
  };

  img.src = photos[modalPhotoIdx];
  img.alt = `Image ${modalPhotoIdx + 1} from ${escapeHtml(t.from || "Anonymous")}`;
  caption.textContent = `${escapeHtml(t.from || "Anonymous")}: Photo ${modalPhotoIdx + 1} of ${photos.length}`;

  prevBtn.classList.toggle('hidden', photos.length <= 1);
  nextBtn.classList.toggle('hidden', photos.length <= 1);
  prevBtn.disabled = (modalPhotoIdx === 0);
  nextBtn.disabled = (modalPhotoIdx === photos.length - 1);
}

function closeModalGallery() {
  const modal = document.getElementById("galleryModal");
  const modalContent = document.getElementById("modalContent");

  modal.style.opacity = '0'; // Fade out background
  modalContent.style.transform = 'scale(0.95)'; // Scale out content

  // Wait for transition to finish before hiding and cleaning up
  setTimeout(() => {
      modal.classList.add("hidden");
      document.getElementById('modalImg').src = ''; // Clear image src
      document.body.style.overflow = ''; // Restore scrolling
  }, 200); // Match transition duration
}

document.getElementById('closeModalBtn').onclick = closeModalGallery;
document.getElementById('modalBG').onclick = closeModalGallery;

document.getElementById('prevImgBtn').onclick = function(e) {
  e.stopPropagation(); // Prevent modalBG click
  if (modalPhotoIdx > 0) {
    modalPhotoIdx--;
    renderModalImage();
  }
}
document.getElementById('nextImgBtn').onclick = function(e) {
  e.stopPropagation(); // Prevent modalBG click
  let t = tributes[modalTributeIdx];
  if (t && t.photos && modalPhotoIdx < t.photos.length - 1) {
    modalPhotoIdx++;
    renderModalImage();
  }
}

window.addEventListener("keydown", function(e){
  if(document.getElementById("galleryModal").classList.contains("hidden")) return;
  if(e.key=="ArrowLeft") {
      e.preventDefault(); // Prevent page scroll
      document.getElementById('prevImgBtn').click();
  }
  if(e.key=="ArrowRight") {
      e.preventDefault(); // Prevent page scroll
      document.getElementById('nextImgBtn').click();
  }
  if(e.key=="Escape") {
      e.preventDefault();
      closeModalGallery();
  }
});

// Page mount effects
document.addEventListener("DOMContentLoaded", function() {
  renderAllTributes();
  // Add listener for resize to potentially re-apply mobile hover simulation
  window.addEventListener('resize', applyMobileHoverSimulation);

  // Animate grid on load (subtle)
  const grid = document.getElementById('tributesGrid');
  if (grid) {
      grid.style.opacity = '0';
      grid.style.transform = 'translateY(20px)';
      setTimeout(() => {
          grid.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
          grid.style.opacity = '1';
          grid.style.transform = 'translateY(0)';
      }, 100); // Short delay after render
  }

  // Clean up any leaked object URLs on beforeunload/pagehide
  const cleanupObjectUrls = () => {
      tributes = getTributes(); // Get current tributes state
      tributes.forEach(t => {
          if (t.photos && Array.isArray(t.photos)) {
              t.photos.forEach(ph => {
                  if (ph && typeof ph === 'string' && ph.startsWith('blob:')) {
                      try { URL.revokeObjectURL(ph); } catch(err) { /* ignore */ }
                  }
              });
          }
      });
  };
  window.addEventListener('pagehide', cleanupObjectUrls);
  window.addEventListener('beforeunload', cleanupObjectUrls);
});
</script>
</body>
</html>
