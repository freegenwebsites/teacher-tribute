<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Retiring Teacher Tribute Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">
  <!-- Google Fonts Indie Flower & Quicksand -->
  <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Quicksand', 'Indie Flower', cursive, sans-serif;
      min-height: 100vh;
      background: repeating-linear-gradient(
        135deg,
        #fff8fc 0px,
        #ffe5ec 22px,
        #fff7fb 44px
      );
    }
    /* Card core style */
    .tribute-card {
      position: relative;
      background: linear-gradient(135deg, #fcf2ff 86%, #ffedf3 100%);
      box-shadow: 0 8px 32px 0 rgba(206, 150, 255, 0.10);
      border-radius: 1.5rem;
      padding: 1.8rem 1.6rem 1rem 1.6rem;
      transition:
        transform 0.24s cubic-bezier(.34,1.56,.64,1),
        box-shadow 0.19s;
      will-change: transform, box-shadow;
      margin-bottom: 0.7rem;
      min-height: 310px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .tribute-card:hover, .tribute-card.card-mobile-anim {
      transform: translateY(-12px) scale(1.037) rotate(-1.6deg);
      z-index:10;
      box-shadow: 0 18px 48px rgba(238, 156, 255, .21), 0 1.5px 8px rgba(122,122,216,.09);
    }
    /* Fan-like gallery styling/animation */
    .fan-stack {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.1rem auto;
      position: relative;
      min-height: 110px;
      width: 170px;
      pointer-events: none;
    }
    .fan-img {
      width: 98px;
      height: 98px;
      object-fit: cover;
      border-radius: 1.1rem;
      box-shadow: 0 6px 18px rgba(220, 176, 253, 0.20);
      transform-origin: 50% 80%;
      position: absolute;
      cursor: pointer;
      border: 2.5px solid #e6d2ff;
      z-index: 1;
      background: #fffbfe;
      transition:
        box-shadow 0.18s cubic-bezier(.34,1.3,.67,1.08),
        transform 0.29s cubic-bezier(.38,1.3,.67,.94),
        z-index 0.19s;
      pointer-events: auto;
      filter: brightness(0.99) saturate(99%);
    }
    .fan-img.fan-expanded,
    .fan-img:hover,
    .fan-img.fan-anim {
      z-index: 10 !important;
      transform: scale(1.18) translateY(-7px) !important;
      box-shadow: 0 12px 39px 0 rgba(220,176,253,0.28);
      filter: brightness(1.08);
    }
    @keyframes fanPop {
      0%   { transform: scale(.82) rotate(0deg);}
      67%  { transform: scale(1.13) rotate(3deg);}
      100% { transform: scale(1)   rotate(0deg);}
    }
    .fan-img.fan-pop {
      animation: fanPop 0.74s cubic-bezier(.65,1.7,.5,.8);
    }
    /* Cute background hearts */
    .floating-heart {
      position: absolute;
      font-size: 1.16rem;
      opacity: 0.16;
      pointer-events: none;
      animation: floatHeart 8s linear infinite;
      z-index: 0;
    }
    @keyframes floatHeart {
      0% {transform: translateY(36px) scale(1.1);}
      100% {transform: translateY(-210px) scale(1);}
    }
    .custom-scrollbar::-webkit-scrollbar {width: 7px;}
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #d7aefb; border-radius: 10px;}
    .custom-scrollbar::-webkit-scrollbar-track { background: #f2e1ff;}
    /* Scroll in animation for lots of cards (for PDF no delay to keep all on page) */
    /* Hide up/down arrows for number input (cosmetic) */
    input::-webkit-inner-spin-button, input::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] { -moz-appearance: textfield; }

    /* For PDF optimization: never force overflow/scroll or page breaks */
    html,
    body {
      overflow: initial !important;
      box-sizing: border-box;
      width: 100%;
    }
    /* Tiny Card Utilities */
    .stripe-bg {
      background: repeating-linear-gradient(
        135deg,
        #fff9fb 0px,
        #ffd7e6 18px,
        #fff6fa 32px
      );
    }
  </style>
</head>
<body class="pb-10">
  <!-- Cute floating hearts background (non-repeating) -->
  <span class="floating-heart left-10 top-24" style="animation-delay:0s; color:#f890b4;"><i class="fa-solid fa-heart"></i></span>
  <span class="floating-heart left-2/3 top-12" style="animation-delay:1.4s; color:#dcb8ff;"><i class="fa-solid fa-heart"></i></span>
  <span class="floating-heart right-8 top-36" style="animation-delay:0.8s; color:#fcddec;"><i class="fa-solid fa-heart"></i></span>
  <span class="floating-heart left-1/4 top-48" style="animation-delay:2.5s; color:#fcb6c0;"><i class="fa-solid fa-heart"></i></span>

  <div class="max-w-5xl mx-auto mt-11 px-3">
    <!-- Title & Description -->
    <div class="text-center mb-7">
      <h1 class="mb-2" style="font-family:'Indie Flower',cursive;font-size:2.21rem;color:#bb57df;text-shadow:0 2px 7px #fed8f5b2;letter-spacing:1.8px;">
        ðŸŒ¸ Happy Retirement, Teacher!
      </h1>
      <p style="font-family:'Indie Flower',cursive;color:#6d4fa8;font-size: 1.11rem;opacity:.92;text-align:center;">
        A truly great teacher is hard to find, difficult to part with, and impossible to forget.<br>
        <span class="text-pink-400 font-semibold">Leave your heartfelt words &amp; pictures below!</span>
      </p>
    </div>
    <!-- Add/Edit Tribute Form -->
    <form id="tributeForm" class="mb-8 stripe-bg border border-pink-200 rounded-2xl py-5 px-4 shadow-lg flex flex-wrap items-center justify-between">
      <input type="hidden" id="editIndex" value="">
      <div class="flex flex-col w-full md:w-1/4 mb-2 md:mb-0 md:pr-3">
        <label for="fromName" class="text-purple-500 font-semibold mb-1">Your Name</label>
        <input id="fromName" name="fromName" type="text" class="rounded-xl border border-purple-200 px-3 py-2 focus:ring-2 focus:ring-pink-200 focus:outline-none" maxlength="32" required placeholder="E.g. Jamie">
      </div>
      <div class="flex flex-col w-full md:w-1/2 md:px-2 mb-2 md:mb-0">
        <label for="message" class="text-purple-500 font-semibold mb-1">Message</label>
        <textarea id="message" name="message" rows="2" class="rounded-xl border border-purple-200 px-3 py-2 focus:ring-2 focus:ring-pink-200 focus:outline-none" maxlength="220" required placeholder="Write your message..."></textarea>
      </div>
      <div class="flex flex-col w-full md:w-1/6 md:pl-2 mb-2 md:mb-0">
        <label for="photos" class="text-purple-500 font-semibold mb-1">
          Photos<br>
          <span class="text-xs font-normal text-gray-400">(up to 4)</span>
        </label>
        <input id="photos" name="photos" type="file" multiple accept="image/*" class="border rounded-xl py-2 px-1 text-xs bg-pink-50">
      </div>
      <div class="w-full md:w-auto flex items-end justify-start md:justify-end mt-2 md:mt-0">
        <button id="submitBtn" type="submit" class="bg-gradient-to-r from-pink-300 to-violet-400 hover:from-rose-200 hover:to-violet-700 font-bold py-2 px-7 text-white rounded-xl focus:outline-none transition-transform transform active:scale-95 shadow">
          <i class="fa-solid fa-paper-plane mr-1"></i>
          <span id="submitBtnText">Share</span>
        </button>
        <button type="button" id="cancelEditBtn" class="ml-2 hidden px-4 py-2 rounded-xl bg-gray-200 text-gray-600 font-semibold hover:bg-gray-300 focus:outline-none transition duration-100">Cancel</button>
      </div>
    </form>

    <!-- Tribute Cards Grid (No scrollbar for PDF compatibility) -->
    <div id="tributesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10 custom-scrollbar"></div>
    <div id="emptyState" class="text-center text-purple-300 italic mt-10 text-lg hidden">
      <i class="fa-solid fa-star fa-bounce mr-2"></i>No tributes yet. Be the first to post your message!
    </div>
  </div>
  
  <!-- Modal for single photo view -->
  <div id="galleryModal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
    <div class="absolute inset-0 cursor-pointer" id="modalBG"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-2 flex flex-col items-center px-2 py-5 border-2 border-purple-100">
      <button type="button" id="closeModalBtn" class="absolute right-2 top-2 text-2xl text-purple-500 hover:text-pink-400 focus:outline-none z-10" title="Close">
        <i class="fa-solid fa-xmark"></i>
      </button>
      <div class="w-full flex items-center justify-center mb-3">
        <button type="button" id="prevImgBtn" class="text-xl text-purple-300 hover:text-purple-600 px-3 focus:outline-none hidden">
          <i class="fa-solid fa-chevron-left"></i>
        </button>
        <div id="modalImgContainer" class="max-w-xs sm:max-w-md md:max-w-lg lg:max-w-xl rounded-xl overflow-hidden bg-gray-50 shadow">
          <img id="modalImg" src="" alt="Gallery Image" class="object-contain mx-auto" style="max-height:50vh;">
        </div>
        <button type="button" id="nextImgBtn" class="text-xl text-purple-300 hover:text-purple-600 px-3 focus:outline-none hidden">
          <i class="fa-solid fa-chevron-right"></i>
        </button>
      </div>
      <div id="galleryCaption" class="text-center text-xs mt-2 mb-2 text-gray-500"></div>
    </div>
  </div>

  <footer class="w-full text-center py-7 mt-10 text-gray-400 text-base">
    <i class="fa-solid fa-cake-candles text-pink-300"></i>
    <span>Made with &hearts; for an unforgettable teacher's new adventure.</span>
  </footer>

<script>
  // --- STATE ---
  let tributes = [];
  let editingTributeId = null;

// --- UTILS ---
function escapeHtml(str) {
  // Escapes special characters for safe HTML insertion
  return String(str).replace(/[&<>"']/g, s => ({
    '&': '&',  // Use & for ampersand
    '<': '<',   // Use < for less than
    '>': '>',   // Use > for greater than
    '"': '"', // Use " for double quote
    "'": '&#39;'  // Use ' for single quote (THE CORRECT LINE)
  }[s]));
}

  function formatDateString(dbDateString) {
      if (!dbDateString) return '';
      try {
          const date = new Date(dbDateString);
          return date.toLocaleDateString("en-US", { month: 'short', day: 'numeric', year: 'numeric' });
      } catch (e) {
          console.error("Error formatting date:", dbDateString, e);
          return '';
      }
  }

  // --->>> NEW HELPER FUNCTION FOR IMAGE PROCESSING <<<---
  // Reads selected files and returns an array of Base64 Data URLs
  async function filesToDataURLs(fileList) {
    const dataURLs = [];
    // Limit to the first 4 files selected
    const filesToProcess = Array.from(fileList).slice(0, 4);

    // Create a promise for each file reader
    const readerPromises = filesToProcess.map(file => {
      return new Promise((resolve, reject) => {
        // Basic image type check (optional but recommended)
        if (!file.type.startsWith('image/')) {
          console.warn(`Skipping non-image file: ${file.name}`);
          resolve(null); // Resolve with null for non-images
          return;
        }
        // Basic size check (e.g., 5MB limit - adjust as needed)
        if (file.size > 5 * 1024 * 1024) {
             console.warn(`Skipping large file (>5MB): ${file.name}`);
             resolve(null); // Resolve with null for large files
             return;
        }

        const reader = new FileReader();
        reader.onload = () => resolve(reader.result); // Resolve with the Data URL string
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file); // Read file as Base64 Data URL
      });
    });

    // Wait for all file readers to complete
    const results = await Promise.all(readerPromises);

    // Filter out any null results (from skipped files)
    return results.filter(url => url !== null);
  }
  // --->>> END OF NEW HELPER FUNCTION <<<---


  // --- RENDERING ---

  function renderAllTributes() {
    const grid = document.getElementById("tributesGrid");
    const emptyState = document.getElementById('emptyState');
    grid.innerHTML = "";

    if (!tributes || !tributes.length) {
      emptyState.classList.remove('hidden');
      return;
    }

    emptyState.classList.add('hidden');
    tributes.forEach((trb, idx) => {
      grid.innerHTML += renderTributeCard(trb, idx);
    });

    attachCardEventListeners();
    setupCardAnimations();
  }

  // Renders the fan-out image gallery for a card
  function renderFanGallery(photos, tributeIdx) {
    const photoArray = Array.isArray(photos) ? photos : [];

    if (!photoArray.length) {
      return `
        <div class="w-20 h-20 flex items-center justify-center text-pink-300 rounded-full bg-pink-50 border-2 border-pink-100 shadow mb-3 text-3xl"><i class="fa-solid fa-flower"></i></div>
      `;
    }

    let imgMarkup = "";
    let n = Math.min(photoArray.length, 4);
    let spread = (n === 1) ? [0] : (n === 2) ? [-18, 18] : (n === 3) ? [-18, 0, 18] : [-24, -8, 8, 24];
    let shiftBase = (n > 1) ? (n - 1) * 49 / 2 : 0;

    for (let i = 0; i < n; i++) {
      if (typeof photoArray[i] !== 'string' || !photoArray[i]) continue;
      let ang = spread[i];
      let l = (n > 1) ? (i * 49) - shiftBase : 0;
      // Use the Data URL directly in src. Escape it just in case, although Data URLs are generally safe.
      imgMarkup += `<img
        src="${escapeHtml(photoArray[i])}"
        class="fan-img"
        data-tidx="${tributeIdx}"
        data-pidx="${i}"
        tabindex="0"
        style="transform:rotate(${ang}deg) translateX(${l}px);"
        alt="Tribute Photo ${i + 1}"
      >`;
    }
    return `<div class="fan-stack mb-1">${imgMarkup}</div>`;
  }

  // Renders a single tribute card
  function renderTributeCard(tribute, idx) {
    const icons = ['fa-flower','fa-apple-whole','fa-star','fa-heart','fa-seedling','fa-book'];
    const tributeId = tribute.id;

    return `
      <div class="tribute-card stripe-bg relative min-h-[310px]" data-cardidx="${idx}" data-id="${tributeId}">
        <div class="absolute right-3 top-3 flex space-x-2 z-10 opacity-80 hover:opacity-100 transition-all">
          <button title="Edit" data-act="edit" data-id="${tributeId}" class="text-purple-400 hover:text-yellow-500 bg-white rounded-full shadow border border-purple-100 px-2 py-1 focus:outline-none transition">
            <i class="fa-solid fa-pen"></i>
          </button>
          <button title="Delete" data-act="delete" data-id="${tributeId}" class="text-purple-400 hover:text-pink-500 bg-white rounded-full shadow border border-purple-100 px-2 py-1 focus:outline-none transition">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
        ${renderFanGallery(tribute.photos, idx)} {/* Call renderFanGallery */}
        <div class="text-purple-500 font-bold mb-1" style="font-family:'Indie Flower',cursive">${escapeHtml(tribute.from || "Anonymous")}</div>
        <div class="text-gray-700 mb-3 text-center" style="font-family:'Indie Flower',cursive;font-size:1.12rem;">${escapeHtml(tribute.msg || '').replace(/\n/g, "<br>")}</div>
        <div class="text-xs text-pink-400 absolute bottom-3 left-1/2 transform -translate-x-1/2 flex items-center gap-1">
          <i class="fa-solid ${icons[idx % icons.length]}"></i>
          <span>${formatDateString(tribute.date) || ''}</span>
        </div>
      </div>
    `;
  }

  // --- API INTERACTIONS ---
  async function fetchAndRenderTributes() {
    const grid = document.getElementById("tributesGrid");
    const emptyState = document.getElementById('emptyState');
    grid.innerHTML = '<p class="text-purple-400 text-center col-span-full italic">Loading tributes...</p>';
    emptyState.classList.add('hidden');
    try {
      const response = await fetch('/.netlify/functions/get-tributes');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      tributes = await response.json();
      renderAllTributes();
    } catch (error) {
      console.error("Failed to fetch tributes:", error);
      grid.innerHTML = '<p class="text-red-500 text-center col-span-full">Could not load tributes. Please check connection or try again later.</p>';
      emptyState.classList.add('hidden');
    }
  }

  async function submitTribute(tributeData, idToUpdate = null) {
    const isUpdating = idToUpdate !== null;
    const endpoint = isUpdating ? '/.netlify/functions/update-tribute' : '/.netlify/functions/add-tribute';
    const method = isUpdating ? 'PUT' : 'POST';
    const payload = isUpdating ? { ...tributeData, id: idToUpdate } : tributeData;
    try {
      const response = await fetch(endpoint, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        // Base64 strings can be long, ensure server/function can handle potentially large JSON payload
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        let errorMsg = `HTTP error! status: ${response.status}`;
        try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (e) { /* Ignore */ }
        throw new Error(errorMsg);
      }
      await fetchAndRenderTributes();
      return true;
    } catch (error) {
      console.error(`Failed to ${isUpdating ? 'update' : 'add'} tribute:`, error);
      alert(`Error ${isUpdating ? 'updating' : 'sharing'} tribute: ${error.message}`);
      return false;
    }
  }

   async function deleteTribute(tributeId) {
    // Convert ID to number for consistency if needed, though backend might handle string
    const idToDelete = parseInt(tributeId, 10);
    if (isNaN(idToDelete)) {
        console.error("Invalid ID for deletion:", tributeId);
        return false;
    }

    if (!confirm('Are you sure you want to delete this tribute? This cannot be undone.')) {
        return false;
    }
    try {
        const response = await fetch('/.netlify/functions/delete-tribute', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: idToDelete }) // Send numeric ID
        });
        if (!response.ok) {
            let errorMsg = `HTTP error! status: ${response.status}`;
             try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (e) { /* Ignore */ }
            throw new Error(errorMsg);
        }
        await fetchAndRenderTributes();
        return true;
    } catch (error) {
        console.error("Failed to delete tribute:", error);
        alert(`Error deleting tribute: ${error.message}`);
        return false;
    }
  }

  // --- FORM LOGIC (Function Definitions) ---

  // --->>> MODIFIED handleFormSubmit TO INCLUDE FILE PROCESSING <<<---
  async function handleFormSubmit(e) {
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    const submitBtnText = document.getElementById('submitBtnText');
    const fileInput = document.getElementById('photos'); // Get the file input

    // Disable button immediately
    submitBtn.disabled = true;
    // Set loading text based on edit state
    const originalBtnText = editingTributeId ? "Update" : "Share";
    const actionText = editingTributeId ? 'Updating...' : 'Sharing...';
    submitBtnText.textContent = actionText;

    // Show a temporary "processing images" message if files are selected
    if (fileInput.files.length > 0) {
         submitBtnText.textContent = editingTributeId ? 'Processing & Updating...' : 'Processing & Sharing...';
    }

    let photos = []; // Default to empty array for photos
    try {
        // --- Process Files ---
        if (fileInput.files.length > 0) {
            // Call the helper function to get Data URLs
            photos = await filesToDataURLs(fileInput.files);
            // 'photos' is now an array of Base64 Data URL strings
        }
        // --- End Process Files ---

        // Get other form data
        const from = document.getElementById('fromName').value.trim() || "Anonymous";
        const msg = document.getElementById('message').value.trim();

        // Create the data payload including the photos array (with Data URLs)
        const tributeData = { from, msg, photos };

        // Get the ID to update (will be null if adding)
        // Convert string ID from hidden input/state to number if necessary for backend
        const idToUpdate = editingTributeId ? parseInt(editingTributeId, 10) : null;
        if (editingTributeId && isNaN(idToUpdate)) {
             throw new Error("Invalid tribute ID for update.");
        }


        // Call the backend submission function
        const success = await submitTribute(tributeData, idToUpdate);

        if (success) {
            resetForm(); // Reset form only on success
        } else {
            // Restore button state on failure (already handled in submitTribute catch)
             submitBtn.disabled = false; // Ensure re-enabled
             submitBtnText.textContent = originalBtnText;
        }
    } catch (error) {
        // Catch errors during file processing or submission
        console.error("Error during form submission:", error);
        alert("An error occurred while processing your tribute. Please try again.");
        // Restore button state on failure
        submitBtn.disabled = false;
        submitBtnText.textContent = originalBtnText;
    }
  }
  // --->>> END OF MODIFIED handleFormSubmit <<<---


  function resetForm() {
      document.getElementById('tributeForm').reset();
      document.getElementById('submitBtnText').textContent = "Share";
      document.getElementById('cancelEditBtn').classList.add('hidden');
      // document.getElementById('editIndex').value = ""; // Might not be needed if using editingTributeId state
      editingTributeId = null; // Clear editing state
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = false;
  }

  // --- EDIT/CANCEL LOGIC (Function Definitions) ---
  function loadEditForm(tributeId) {
    // --- > MODIFIED TO PARSE INT FOR ID COMPARISON < ---
    const tributeIdAsNumber = parseInt(tributeId, 10); // Convert attribute string to number
     if (isNaN(tributeIdAsNumber)) {
         console.error("Invalid tribute ID passed to loadEditForm:", tributeId);
         return;
     }

    const tributeToEdit = tributes.find(t => t.id === tributeIdAsNumber); // Compare numbers
    // --- > END OF MODIFICATION < ---

    if (!tributeToEdit) {
        console.error("Could not find tribute with ID:", tributeIdAsNumber);
        // Display the alert *after* logging the ID we searched for
        alert("Could not load tribute for editing.");
        return;
    }
    document.getElementById('fromName').value = tributeToEdit.from;
    document.getElementById('message').value = tributeToEdit.msg;
    // Cannot set file input value. User must re-select files if they want to change them during edit.
    // Consider showing existing photos (if any) separately near the form during edit.

    // document.getElementById('editIndex').value = tributeId; // Store original string ID if needed
    editingTributeId = tributeIdAsNumber; // Store the numeric ID for update state
    document.getElementById('submitBtnText').textContent = "Update";
    document.getElementById('cancelEditBtn').classList.remove('hidden');
    window.scrollTo({top: 0, behavior: 'smooth'});
  }

  // --- CARD BUTTONS / IMAGE EVENTS (Function Definitions) ---
  function attachCardEventListeners() {
    const grid = document.getElementById('tributesGrid');
    if (!grid) return;

    // Use one click listener on the grid (event delegation)
    grid.onclick = function handleGridClick(event) {
        const target = event.target;
        const button = target.closest('button[data-act]');
        const img = target.closest('.fan-img');

        if (button) {
            event.stopPropagation();
            const action = button.getAttribute('data-act');
            const id = button.getAttribute('data-id'); // ID from attribute is a STRING
            if (!id) return;

            if (action === 'edit') {
                loadEditForm(id); // Pass the STRING id to loadEditForm
            } else if (action === 'delete') {
                deleteTribute(id); // Pass the STRING id to deleteTribute
            }

        } else if (img) {
            event.stopPropagation();
            const tIdx = parseInt(img.getAttribute("data-tidx"));
            const pIdx = parseInt(img.getAttribute("data-pidx"));
            if (!isNaN(tIdx) && !isNaN(pIdx) && tributes[tIdx]) {
                 showModalGallery(tIdx, pIdx);
            } else { console.error("Invalid index or tribute data for modal. tIdx:", tIdx, "pIdx:", pIdx); }
        }
    };

     // Attach listeners directly to images (needed for hover, keydown less efficient than delegation but okay)
     document.querySelectorAll('.fan-img').forEach(img => {
         img.onkeydown = function(e) {
             if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); img.click(); }
         }
         img.removeEventListener('mouseenter', handleFanMouseEnter);
         img.removeEventListener('mouseleave', handleFanMouseLeave);
         img.addEventListener('mouseenter', handleFanMouseEnter);
         img.addEventListener('mouseleave', handleFanMouseLeave);
     });
  }
  function handleFanMouseEnter() { this.classList.add('fan-expanded'); }
  function handleFanMouseLeave() { this.classList.remove('fan-expanded'); }


  function setupCardAnimations() {
      if ('IntersectionObserver' in window) {
          document.querySelectorAll('.fan-img').forEach(img => {
              img.classList.remove('fan-anim', 'fan-pop');
              const observer = new IntersectionObserver((entries, observerInstance) => {
                  entries.forEach(entry => {
                      if (entry.isIntersecting) {
                          img.classList.add('fan-pop');
                          setTimeout(() => img.classList.remove('fan-pop'), 700);
                          observerInstance.unobserve(img);
                      }
                  });
              }, { threshold: 0.5 });
              observer.observe(img);
          });
          document.querySelectorAll('.tribute-card').forEach(card => {
              card.classList.remove('card-mobile-anim');
              const observer = new IntersectionObserver((entries, observerInstance) => {
                  entries.forEach(entry => {
                      if (entry.isIntersecting) {
                          card.classList.add('card-mobile-anim');
                          setTimeout(() => card.classList.remove('card-mobile-anim'), 690);
                          observerInstance.unobserve(card);
                      }
                  });
              }, { threshold: 0.42 });
              observer.observe(card);
          });
      }
  }

  // --- MODAL GALLERY LOGIC (Function Definitions) ---
  let modalTributeIdx = 0, modalPhotoIdx = 0;

  function showModalGallery(tributeIdx, photoIdx) {
    if (!tributes[tributeIdx]) { console.error("Tribute data unavailable for modal index:", tributeIdx); return; }
    modalTributeIdx = tributeIdx;
    modalPhotoIdx = photoIdx;
    renderModalImage();
    document.getElementById("galleryModal").classList.remove("hidden");
    document.body.style.overflow = 'hidden';
  }

  function renderModalImage() {
    let t = tributes[modalTributeIdx];
    let photos = Array.isArray(t.photos) ? t.photos : [];
    let currentPhotoSrc = photos[modalPhotoIdx];

    if (typeof currentPhotoSrc !== 'string' || !currentPhotoSrc) {
        console.warn("Photos array empty or photo index/src invalid for modal.");
        closeModalGallery(); return;
    }

    document.getElementById('modalImg').src = currentPhotoSrc; // Use Data URL directly
    document.getElementById('galleryCaption').textContent = `${t.from || "Anonymous"}: ${modalPhotoIdx + 1} / ${photos.length}`;
    document.getElementById('prevImgBtn').classList.toggle('hidden', modalPhotoIdx === 0);
    document.getElementById('nextImgBtn').classList.toggle('hidden', modalPhotoIdx >= photos.length - 1);
  }

  function closeModalGallery() {
    document.getElementById("galleryModal").classList.add("hidden");
    document.getElementById('modalImg').src = '';
    document.body.style.overflow = '';
  }

  // --- INITIALIZE & EVENT LISTENERS ---
  document.addEventListener("DOMContentLoaded", function() {
    fetchAndRenderTributes();

    try {
        const tributeForm = document.getElementById('tributeForm');
        if (tributeForm) { tributeForm.onsubmit = handleFormSubmit; }
        else { console.error("Could not find element with ID 'tributeForm'"); }

        const cancelBtn = document.getElementById('cancelEditBtn');
        if (cancelBtn) { cancelBtn.onclick = resetForm; }
        else { console.error("Could not find element with ID 'cancelEditBtn'"); }

        const closeModalBtn = document.getElementById('closeModalBtn');
        if (closeModalBtn) { closeModalBtn.onclick = closeModalGallery; }
        else { console.error("Could not find element with ID 'closeModalBtn'"); }

        const modalBG = document.getElementById('modalBG');
        if (modalBG) { modalBG.onclick = closeModalGallery; }
        else { console.error("Could not find element with ID 'modalBG'"); }

        const prevImgBtn = document.getElementById('prevImgBtn');
        if (prevImgBtn) {
            prevImgBtn.onclick = function(e) {
                e.stopPropagation(); if (modalPhotoIdx > 0) { modalPhotoIdx--; renderModalImage(); }
            };
        } else { console.error("Could not find element with ID 'prevImgBtn'"); }

        const nextImgBtn = document.getElementById('nextImgBtn');
        if (nextImgBtn) {
            nextImgBtn.onclick = function(e) {
                e.stopPropagation(); let t = tributes[modalTributeIdx]; let photos = Array.isArray(t.photos) ? t.photos : []; if (modalPhotoIdx < photos.length - 1) { modalPhotoIdx++; renderModalImage(); }
            };
        } else { console.error("Could not find element with ID 'nextImgBtn'"); }

    } catch (error) { console.error("Error attaching event listeners:", error); }

    window.addEventListener("keydown", function(e) {
        const modal = document.getElementById("galleryModal");
        if (!modal || modal.classList.contains("hidden")) return;
        if (e.key === "ArrowLeft") { document.getElementById('prevImgBtn')?.click(); }
        else if (e.key === "ArrowRight") { document.getElementById('nextImgBtn')?.click(); }
        else if (e.key === "Escape") { closeModalGallery(); }
    });

  }); // End of DOMContentLoaded

  // No longer need onbeforeunload for blob URLs
</script>
</body>
</html>


