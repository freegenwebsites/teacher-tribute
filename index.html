<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Illustrated Retiring Teacher Tribute Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind CSS 2.2.19 -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome 6.5.2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">
  <!-- Google Fonts: Indie Flower & Quicksand -->
  <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Quicksand', 'Indie Flower', cursive, sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #fdf6e3 0%, #e0e7ff 100%);
    }
    /* Card base style */
    .tribute-card {
      position: relative;
      background: linear-gradient(135deg, #e8f5e9 85%, #ffe0e8 100%);
      box-shadow: 0 8px 32px 0 rgba(156, 195, 255, 0.13);
      border-radius: 1.6rem;
      padding: 1.9rem 1.6rem 1.2rem 1.6rem;
      /* Keep card hover animation */
      transition:
        transform 0.24s cubic-bezier(.24,1.46,.54,1.07),
        box-shadow 0.19s;
      margin-bottom: 0.7rem;
      min-height: 325px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .tribute-card:hover, .tribute-card.card-mobile-anim {
      transform: translateY(-12px) scale(1.04) rotate(-1.6deg);
      z-index:10;
      box-shadow: 0 24px 62px 0 rgba(194, 180, 255, 0.23), 0 1.5px 8px rgba(122,122,216,.10);
    }

    /* --- Fan image stack (Static Version) --- */
    .fan-stack {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      min-height: 112px;
      width: 176px;
      position: relative;
      margin: 0 auto 1.2rem auto;
      pointer-events: none; /* Container doesn't need events */
    }
    .fan-img {
      width: 96px;
      height: 96px;
      object-fit: cover;
      border-radius: 1.12rem;
      box-shadow: 0 9px 26px rgba(160, 190, 255, 0.24); /* Static shadow */
      transform-origin: 50% 80%;
      position: absolute;
      background: #f9fafb;
      border: 2.5px solid #d6edea;
      z-index: 1; /* Base z-index */
      cursor: pointer; /* Still clickable */
      pointer-events: auto; /* Images are clickable */
      /* Remove transition for hover effects */
      /* transition: ... */
      filter: brightness(.99) saturate(98%);
      /* Inline transform sets the static fan position */
    }

    /* --- DELETE CSS Rules for Fan Animation --- */
    /*
    .fan-img.fan-expanded,
    .fan-img.fan-anim,
    .fan-img:hover {
      z-index: 10 !important;
      transform: scale(1.18) translateY(-7px) !important;
      box-shadow: 0 13px 44px 0 rgba(180,176,255,0.22);
      filter: brightness(1.08);
    }
    @keyframes fanPop {
      0%   { transform: scale(.82) rotate(0deg);}
      72%  { transform: scale(1.17) rotate(3deg);}
      100% { transform: scale(1)   rotate(0deg);}
    }
    .fan-img.fan-pop {
      animation: fanPop 0.78s cubic-bezier(.65,1.7,.5,.8);
    }
    */
    /* --- End Deleted CSS Rules --- */


    /* Placeholder style (reusing school-illustration for size/shape) */
    /* Also added .initial-placeholder for potential targeting */
    .school-illustration, .initial-placeholder {
      width: 97px;
      height: 97px;
      border-radius: 1.12rem;
      display: flex;
      align-items: center;
      justify-content: center;
      /* Background set by inline style in JS now */
      border: 2.5px solid #e2e6f7;
      box-shadow: 0 6px 19px rgba(180, 210, 255, 0.16);
      font-size: 2.9rem; /* Base size for SVG */
      margin: 0 auto 0.3rem auto; /* Keep margin consistent */
      position: relative;
      overflow: hidden;
      will-change: transform;
      transition: transform .22s;
      animation: bounceInCircle .60s 1; /* Keep entry animation */
    }
    /* Remove specific SVG styling if not needed */
    /* .tribute-card .school-illustration svg { ... } */
    @keyframes bounceInCircle {
      0%   { transform: scale(.78) rotate(-6deg); opacity:.2;}
      70%  { transform: scale(1.12) rotate(9deg); opacity:1;}
      100% { transform: scale(1) rotate(0deg);}
    }

    /* Floating celebration elements */
    .floating-celebrate {
      position: absolute;
      font-size: 1.23rem;
      opacity: 0.14;
      pointer-events: none;
      animation: floatCelebrate 9.2s linear infinite;
      z-index: 0;
    }
    @keyframes floatCelebrate {
      0%   {transform: translateY(46px) scale(1.17);}
      100% {transform: translateY(-220px) scale(1);}
    }
    /* Custom scrollbar only for browser, not PDF */
    .custom-scrollbar::-webkit-scrollbar {width: 7px;}
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #bbdefb; border-radius: 10px;}
    .custom-scrollbar::-webkit-scrollbar-track { background: #e6eeff;}
    /* Remove num arrows */
    input::-webkit-inner-spin-button, input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0;}
    input[type="number"] { -moz-appearance: textfield; }

    html, body {
      overflow: initial !important;
      box-sizing: border-box;
      width: 100%;
    }
    /* Form styling tweak */
    .stripe-bg {
      background: linear-gradient(105deg, #f7fbff 0, #e3f9ed 85%);
    }
    /* Confetti animation container for success */
    .confetti {
      position: fixed;
      left: 0; top: 0; width: 100%; height: 100%; z-index: 9999;
      pointer-events: none;
      display: flex; align-items: flex-start; justify-content: center;
      overflow: visible;
    }
    .confetti__dot {
      position: absolute;
      width: 18px; height: 18px; border-radius: 99px;
      opacity: 0.84;
      pointer-events: none;
      will-change: transform, opacity;
      animation: confetti-fall 1.7s linear forwards;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-80px) scale(.9) rotate(-20deg);}
      80% { opacity: 1;}
      95% { opacity: .8;}
      100% { transform: translateY(400px) scale(1.05) rotate(80deg); opacity:0;}
    }
    /* Footer animated teacher and caps */
    .footer-party {
      min-height: 90px;
      padding-bottom: 0.1rem;
      position: relative;
      margin-top: 2.5rem;
      background: linear-gradient(88deg, #e1f5fe 70%, #ffe0b2 100%);
      border-radius: 28px 28px 0px 0px;
      box-shadow: 0 0 0 #fff;
      overflow: visible;
    }
    .cap-throw {
      position: absolute;
      left: 25%;
      top: 14px;
      animation: capThrow 2.8s cubic-bezier(.39,1.5,.59,.81) infinite;
      pointer-events: none;
      z-index: 2;
    }
    .cap-throw2 {
      left: 68%; top: 12px;
      animation-delay: 1.1s;
      animation: capThrow2 3.5s cubic-bezier(.40,1.45,.61,.9) infinite;
    }
    @keyframes capThrow {
      0%   { transform: translateY(0px) rotate(3deg);}
      60%  { transform: translateY(-50px) rotate(-30deg);}
      100% { transform: translateY(0px) rotate(2deg);}
    }
    @keyframes capThrow2 {
      0%   { transform: translateY(0px) rotate(-7deg);}
      62%  { transform: translateY(-46px) rotate(20deg);}
      100% { transform: translateY(0px) rotate(-5deg);}
    }
    /* Teacher waving */
    .footer-teacher {
      position: absolute;
      right: 12%; bottom: 12px;
      z-index:3;
      animation: waveHand 2.1s infinite cubic-bezier(.6,1.6,.3,1.01);
      transform-origin: bottom right;
    }
    @keyframes waveHand {
      0%,100% { transform: rotate(0);}
      14% { transform: rotate(-7deg);}
      19% { transform: rotate(11deg);}
      25% { transform: rotate(-12deg);}
      36% { transform: rotate(8deg);}
      47% { transform: rotate(0);}
    }
    /* Hide scroll in PDF */
    @media print {
      .custom-scrollbar { overflow: visible !important;}
    }
  </style>
</head>
<body class="pb-10 selection:bg-yellow-100">
  <!-- Floating celebration elements (school theme) -->
  <span class="floating-celebrate left-12 top-28" style="animation-delay:0.1s; color:#6093e5;"><i class="fa-solid fa-book"></i></span>
  <span class="floating-celebrate left-1/4 top-56" style="animation-delay:1.6s; color:#fdb253;"><i class="fa-solid fa-apple-whole"></i></span>
  <span class="floating-celebrate right-14 top-28" style="animation-delay:0.9s; color:#a3de83;"><i class="fa-solid fa-seedling"></i></span>
  <span class="floating-celebrate left-1/3 top-44" style="animation-delay:2.1s; color:#bb57df;"><i class="fa-solid fa-flower"></i></span>
  <span class="floating-celebrate right-1/4 top-56" style="animation-delay:1.2s; color:#ff8b94;"><i class="fa-solid fa-star"></i></span>
  <span class="floating-celebrate left-3/5 top-96" style="animation-delay:2.36s; color:#5bcfc2;"><i class="fa-solid fa-pencil"></i></span>
  <span class="floating-celebrate left-2/3 top-20" style="animation-delay:0.5s; color:#eab308;"><i class="fa-solid fa-bell"></i></span>

  <div class="max-w-5xl mx-auto mt-11 px-3">
    <!-- Title & Description -->
    <div class="text-center mb-7">
      <h1 class="mb-2" style="font-family:'Indie Flower',cursive;font-size:2.28rem;color:#4e83e1;text-shadow:0 2px 7px #deedffd0;letter-spacing:1.8px;">
        ðŸŒ¼ Happy Retirement, Teacher!
      </h1>
      <p style="font-family:'Indie Flower',cursive;color:#2e577b;font-size: 1.11rem;opacity:.93;text-align:center;">
        A wonderful teacher leaves a mark on hearts forever.<br>
        <span class="text-green-500 font-semibold">Share your words, memories & photos below!</span>
      </p>
    </div>
    <!-- Add/Edit Tribute Form -->
    <form id="tributeForm" class="mb-8 stripe-bg border border-yellow-200 rounded-2xl py-5 px-4 shadow-lg flex flex-wrap items-center justify-between">
      <input type="hidden" id="editIndex" value="">
      <div class="flex flex-col w-full md:w-1/4 mb-2 md:mb-0 md:pr-3">
        <label for="fromName" class="text-blue-500 font-semibold mb-1">Your Name</label>
        <input id="fromName" name="fromName" type="text" class="rounded-xl border border-green-200 px-3 py-2 focus:ring-2 focus:ring-yellow-200 focus:outline-none" maxlength="32" required placeholder="E.g. Jamie">
      </div>
      <div class="flex flex-col w-full md:w-1/2 md:px-2 mb-2 md:mb-0">
        <label for="message" class="text-blue-500 font-semibold mb-1">Message</label>
        <textarea id="message" name="message" rows="2" class="rounded-xl border border-green-200 px-3 py-2 focus:ring-2 focus:ring-yellow-200 focus:outline-none" maxlength="220" required placeholder="Write your message..."></textarea>
      </div>
      <div class="flex flex-col w-full md:w-1/6 md:pl-2 mb-2 md:mb-0">
        <label for="photos" class="text-blue-500 font-semibold mb-1">
          Photos<br>
          <span class="text-xs font-normal text-gray-400">(up to 4)</span>
        </label>
        <input id="photos" name="photos" type="file" multiple accept="image/*" class="border rounded-xl py-2 px-1 text-xs bg-yellow-50">
      </div>
      <div class="w-full md:w-auto flex items-end justify-start md:justify-end mt-2 md:mt-0">
        <button id="submitBtn" type="submit" class="bg-gradient-to-r from-green-300 to-blue-400 hover:from-yellow-200 hover:to-green-700 font-bold py-2 px-7 text-white rounded-xl focus:outline-none transition duration-150 transform active:scale-95 shadow">
          <i class="fa-solid fa-paper-plane mr-1"></i>
          <span id="submitBtnText">Share</span>
        </button>
        <button type="button" id="cancelEditBtn" class="ml-2 hidden px-4 py-2 rounded-xl bg-gray-200 text-gray-600 font-semibold hover:bg-gray-300 focus:outline-none transition duration-100">Cancel</button>
      </div>
    </form>
    <!-- Tribute Cards Grid -->
    <div id="tributesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10 custom-scrollbar"></div>
    <div id="emptyState" class="text-center text-blue-200 italic mt-10 text-lg hidden">
      <i class="fa-solid fa-star fa-bounce mr-2"></i>No tributes yet. Be the first to post your memory!
    </div>
  </div>
  
  <!-- Modal for single photo view -->
  <div id="galleryModal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center">
    <div class="absolute inset-0 cursor-pointer" id="modalBG"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-2 flex flex-col items-center px-2 py-5 border-2 border-green-100">
      <button type="button" id="closeModalBtn" class="absolute right-2 top-2 text-2xl text-green-500 hover:text-yellow-400 focus:outline-none z-10" title="Close">
        <i class="fa-solid fa-xmark"></i>
      </button>
      <div class="w-full flex items-center justify-center mb-3">
        <button type="button" id="prevImgBtn" class="text-xl text-blue-300 hover:text-green-600 px-3 focus:outline-none hidden">
          <i class="fa-solid fa-chevron-left"></i>
        </button>
        <div id="modalImgContainer" class="max-w-xs sm:max-w-md md:max-w-lg lg:max-w-xl rounded-xl overflow-hidden bg-gray-50 shadow">
          <img id="modalImg" src="" alt="Gallery Image" class="object-contain mx-auto" style="max-height:50vh;">
        </div>
        <button type="button" id="nextImgBtn" class="text-xl text-blue-300 hover:text-green-600 px-3 focus:outline-none hidden">
          <i class="fa-solid fa-chevron-right"></i>
        </button>
      </div>
      <div id="galleryCaption" class="text-center text-xs mt-2 mb-2 text-gray-500"></div>
    </div>
  </div>

  <!-- Animated Celebration Footer -->
  <footer class="footer-party w-full text-center mt-10 relative text-base pb-1 select-none">
    <div class="cap-throw"><i class="fa-solid fa-graduation-cap text-blue-400 text-2xl"></i></div>
    <div class="cap-throw cap-throw2"><i class="fa-solid fa-graduation-cap text-yellow-500 text-2xl"></i></div>
    <span class="footer-teacher">
      <svg width="56" height="70" viewBox="0 0 56 70" fill="none">
        <ellipse cx="28" cy="63" rx="25" ry="6" fill="#ffe0b2"/>
        <circle cx="28" cy="34" r="20" fill="#fff"/>
        <ellipse cx="28" cy="43.5" rx="9.5" ry="7.5" fill="#f8bbd0"/>
        <ellipse cx="28" cy="31" rx="13" ry="14" fill="#febc97"/>
        <ellipse cx="23" cy="23" rx="3" ry="2" fill="#624338"/>
        <ellipse cx="33" cy="23" rx="3" ry="2" fill="#624338"/>
        <rect x="18" y="38" width="20" height="4" rx="2" fill="#e57373"/>
        <rect x="25" y="49" width="6" height="18" rx="3" fill="#90caf9"/>
        <!-- Waving hand (ultra simple) -->
        <ellipse cx="45" cy="40" rx="4" ry="4.5" fill="#febc97" style="transform-origin:45px 40px"/>
      </svg>
    </span>
    <span class="block font-semibold pt-10 pb-1" style="font-family:'Indie Flower',cursive;font-size:1.23rem;color:#356ec5;text-shadow:0 1px 7px #c5eaeeda;">
      ðŸŽ‰ With heartfelt wishes for your next amazing chapter! ðŸŽ‰
    </span>
    <span class="block text-gray-400 pb-1" style="font-family:Quicksand,sans-serif;font-size:1rem;">
      Made with <i class="fa-solid fa-heart text-pink-300"></i> by everyone who is grateful for you.
    </span>
  </footer>
  <!-- Confetti effect container (JS) -->
  <div id="confettiBox" class="confetti" style="pointer-events: none; display:none;"></div>

<script>
  // --- STATE ---
  let tributes = [];
  let editingTributeId = null;

  // --- CONSTANTS ---
  // Removed SCHOOL_SVGS array as it's replaced by initials

  // --- UTILS ---

  // --->>> ADDED Color Palette and Hash Function <<<---
  const INITIAL_BG_COLORS = [
    '#a7f3d0', '#bae6fd', '#fecaca', '#fde68a', '#d8b4fe', '#a5f3fc', '#fecdd3', '#e9d5ff',
    '#bfdbfe', '#fbcfe8', '#bbf7d0', '#fef08a', '#fed7aa', '#fecfbb', '#c7d2fe', '#f5d0fe' // Added more colors
  ];
  function getNameColorIndex(name) {
    if (!name) return 0;
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = (hash << 5) - hash + name.charCodeAt(i);
      hash |= 0;
    }
    return Math.abs(hash) % INITIAL_BG_COLORS.length;
  }
  // --->>> END ADDED UTILS <<<---

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      '&': '&',
      '<': '<',
      '>': '>',
      '"': '"',
      "'": '&#39;'
    }[s]));
  }
  function formatDateString(dbDateString) {
    if (!dbDateString || typeof dbDateString !== 'string') return '';
    try {
      const isoFriendlyString = dbDateString.replace(' ', 'T');
      const date = new Date(isoFriendlyString);
      if (isNaN(date.getTime())) return 'Invalid date';
      return date.toLocaleDateString("en-US", { month: 'short', day: 'numeric', year: 'numeric' });
    } catch (e) {
      return '';
    }
  }
  async function filesToDataURLs(fileList) {
    const dataURLs = [];
    const filesToProcess = Array.from(fileList).slice(0, 4);
    const readerPromises = filesToProcess.map(file => {
      return new Promise((resolve, reject) => {
        if (!file.type.startsWith('image/')) return resolve(null);
        if (file.size > 5 * 1024 * 1024) return resolve(null); // 5MB Limit
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
      });
    });
    const results = await Promise.all(readerPromises);
    return results.filter(url => url !== null);
  }

  // --- RENDERING ---
  function renderAllTributes() {
    const grid = document.getElementById("tributesGrid");
    const emptyState = document.getElementById('emptyState');
    grid.innerHTML = "";
    if (!tributes || !tributes.length) {
      emptyState.classList.remove('hidden');
      return;
    }
    emptyState.classList.add('hidden');
    tributes.forEach((trb, idx) => {
      grid.innerHTML += renderTributeCard(trb, idx);
    });
    attachCardEventListeners();
    setupCardAnimations(); // Keep card animations, fan animations removed below
  }

  // --->>> MODIFIED renderFanGallery for Initials <<<---
  function renderFanGallery(tribute, tributeIdx) { // Accepts full tribute object
    const photoArray = Array.isArray(tribute.photos) ? tribute.photos : [];
    const fromName = tribute.from || "A"; // Use name for initial

    if (!photoArray.length) {
      // Generate Initial Placeholder
      const initial = fromName.charAt(0).toUpperCase();
      const colorIndex = getNameColorIndex(fromName);
      const bgColor = INITIAL_BG_COLORS[colorIndex];
      // Re-use school-illustration class for size/shape/border, add initial-placeholder
      return `
        <div class="initial-placeholder school-illustration mb-2 flex items-center justify-center"
             style="background-color: ${bgColor}; border-color: rgba(0,0,0,0.05);"
             title="From: ${escapeHtml(fromName)}">
          <span style="font-family: 'Quicksand', sans-serif; font-size: 2.5rem; font-weight: 700; color: rgba(0,0,0,0.5);">
            ${escapeHtml(initial)}
          </span>
        </div>
      `;
    }

    // Original Photo Fan Logic (Static positioning)
    let imgMarkup = "";
    let n = Math.min(photoArray.length, 4);
    // Adjusted spread/shift slightly for visual preference with static stack
    let spread = (n === 1) ? [0] : (n === 2) ? [-10, 10] : (n === 3) ? [-15, 0, 15] : [-18, -6, 6, 18];
    let shiftBase = (n > 1) ? (n - 1) * 40 / 2 : 0; // Reduced spacing
    for (let i = 0; i < n; i++) {
      if (typeof photoArray[i] !== 'string' || !photoArray[i]) continue;
      let ang = spread[i];
      let l = (n > 1) ? (i * 40) - shiftBase : 0; // Reduced spacing
      // Assign z-index directly in style for static stacking order
      let z = n - i; // Make the last image (top of stack) have lowest index i, highest z
      imgMarkup += `<img
        src="${escapeHtml(photoArray[i])}"
        class="fan-img"
        data-tidx="${tributeIdx}"
        data-pidx="${i}"
        tabindex="0"
        style="transform:rotate(${ang}deg) translateX(${l}px); z-index: ${z};"
        alt="Tribute Photo ${i + 1}">
      `;
    }
    return `<div class="fan-stack mb-1">${imgMarkup}</div>`;
  }
  // --->>> END MODIFIED renderFanGallery <<<---

  // --->>> MODIFIED renderTributeCard to pass full tribute object <<<---
  function renderTributeCard(tribute, idx) {
    const icons = ['fa-flower','fa-apple-whole','fa-star','fa-heart','fa-seedling','fa-book'];
    const tributeId = tribute.id;
    return `
      <div class="tribute-card stripe-bg relative min-h-[325px]" data-cardidx="${idx}" data-id="${tributeId}">
        <div class="absolute right-3 top-3 flex space-x-2 z-10 opacity-80 hover:opacity-100 transition-all">
          <button title="Edit" data-act="edit" data-id="${tributeId}" class="text-blue-400 hover:text-yellow-500 bg-white rounded-full shadow border border-blue-100 px-2 py-1 focus:outline-none transition">
            <i class="fa-solid fa-pen"></i>
          </button>
          <button title="Delete" data-act="delete" data-id="${tributeId}" class="text-blue-400 hover:text-pink-500 bg-white rounded-full shadow border border-blue-100 px-2 py-1 focus:outline-none transition">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
        ${renderFanGallery(tribute, idx)} {/* Pass full tribute object */}
        <div class="text-blue-600 font-bold mb-1" style="font-family:'Indie Flower',cursive">${escapeHtml(tribute.from || "Anonymous")}</div>
        <div class="text-gray-700 mb-3 text-center" style="font-family:'Indie Flower',cursive;font-size:1.14rem;">${escapeHtml(tribute.msg || '').replace(/\n/g, "<br>")}</div>
        <div class="text-xs text-green-500 absolute bottom-3 left-1/2 transform -translate-x-1/2 flex items-center gap-1">
          <i class="fa-solid ${icons[idx % icons.length]}"></i>
          <span>${formatDateString(tribute.date) || ''}</span>
        </div>
      </div>
    `;
  }
  // --->>> END MODIFIED renderTributeCard <<<---

  // --- API INTERACTIONS --- (No changes needed here)
  async function fetchAndRenderTributes() {
    const grid = document.getElementById("tributesGrid");
    const emptyState = document.getElementById('emptyState');
    grid.innerHTML = '<p class="text-blue-400 text-center col-span-full italic">Loading tributes...</p>';
    emptyState.classList.add('hidden');
    try {
      const resp = await fetch('/.netlify/functions/get-tributes');
      if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
      tributes = await resp.json();
      renderAllTributes();
    } catch (error) {
      grid.innerHTML = '<p class="text-red-500 text-center col-span-full">Could not load tributes. Please check connection or try again later.</p>';
      emptyState.classList.add('hidden');
    }
  }
  async function submitTribute(tributeData, idToUpdate = null) {
    const isUpdating = idToUpdate !== null;
    const endpoint = isUpdating ? '/.netlify/functions/update-tribute' : '/.netlify/functions/add-tribute';
    const method = isUpdating ? 'PUT' : 'POST';
    const payload = isUpdating ? { ...tributeData, id: idToUpdate } : tributeData;
    try {
      const response = await fetch(endpoint, {
        method: method, headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        let errorMsg = `HTTP error! status: ${response.status}`;
        try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (e) { }
        throw new Error(errorMsg);
      }
      showConfetti(); // Keep confetti
      await fetchAndRenderTributes();
      return true;
    } catch (error) {
      alert(`Error ${isUpdating ? 'updating' : 'sharing'} tribute: ${error.message}`);
      return false;
    }
  }
  async function deleteTribute(tributeId) {
    const idToDelete = parseInt(tributeId, 10);
    if (isNaN(idToDelete)) return false;
    if (!confirm('Are you sure you want to delete this tribute? This cannot be undone.')) return false;
    try {
      const response = await fetch('/.netlify/functions/delete-tribute', {
        method: 'DELETE', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: idToDelete })
      });
      if (!response.ok) {
        let errorMsg = `HTTP error! status: ${response.status}`;
        try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (e) { }
        throw new Error(errorMsg);
      }
      await fetchAndRenderTributes();
      return true;
    } catch (error) {
      alert(`Error deleting tribute: ${error.message}`);
      return false;
    }
  }

  // --- FORM LOGIC --- (No changes needed here)
  async function handleFormSubmit(e) {
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    const submitBtnText = document.getElementById('submitBtnText');
    const fileInput = document.getElementById('photos');
    submitBtn.disabled = true;
    const originalBtnText = editingTributeId ? "Update" : "Share";
    const actionText = editingTributeId ? 'Updating...' : 'Sharing...';
    submitBtnText.textContent = actionText;
    if (fileInput.files.length > 0) {
      submitBtnText.textContent = editingTributeId ? 'Processing & Updating...' : 'Processing & Sharing...';
    }
    let photos = [];
    try {
      if (fileInput.files.length > 0) {
        photos = await filesToDataURLs(fileInput.files);
      }
      const from = document.getElementById('fromName').value.trim() || "Anonymous";
      const msg = document.getElementById('message').value.trim();
      const tributeData = { from, msg, photos };
      const idToUpdate = editingTributeId ? parseInt(editingTributeId, 10) : null;
      if (editingTributeId && isNaN(idToUpdate)) throw new Error("Invalid tribute ID for update.");
      const success = await submitTribute(tributeData, idToUpdate);
      if (success) {
        resetForm();
      } else {
        submitBtn.disabled = false;
        submitBtnText.textContent = originalBtnText;
      }
    } catch (error) {
      alert("An error occurred while processing your tribute. Please try again.");
      submitBtn.disabled = false;
      submitBtnText.textContent = originalBtnText;
    }
  }
  function resetForm() {
    document.getElementById('tributeForm').reset();
    document.getElementById('submitBtnText').textContent = "Share";
    document.getElementById('cancelEditBtn').classList.add('hidden');
    editingTributeId = null;
    document.getElementById('submitBtn').disabled = false;
  }
  function loadEditForm(tributeId) {
    const tributeIdAsNumber = parseInt(tributeId, 10);
    if (isNaN(tributeIdAsNumber)) return;
    const tributeToEdit = tributes.find(t => t.id === tributeIdAsNumber);
    if (!tributeToEdit) {
      alert("Could not load tribute for editing.");
      return;
    }
    document.getElementById('fromName').value = tributeToEdit.from;
    document.getElementById('message').value = tributeToEdit.msg;
    editingTributeId = tributeIdAsNumber;
    document.getElementById('submitBtnText').textContent = "Update";
    document.getElementById('cancelEditBtn').classList.remove('hidden');
    window.scrollTo({top: 0, behavior: 'smooth'});
  }

  // --- CARD BUTTONS / IMAGE EVENTS ---
  // --->>> MODIFIED attachCardEventListeners to remove fan hover <<<---
  function attachCardEventListeners() {
    const grid = document.getElementById('tributesGrid');
    if (!grid) return;

    grid.onclick = function handleGridClick(event) {
      const target = event.target;
      const button = target.closest('button[data-act]');
      const img = target.closest('.fan-img'); // Click listener for modal still needed

      if (button) {
        event.stopPropagation();
        const action = button.getAttribute('data-act');
        const id = button.getAttribute('data-id');
        if (!id) return;
        if (action === 'edit') {
          loadEditForm(id);
        } else if (action === 'delete') {
          deleteTribute(id);
        }
      } else if (img) { // If a fan image was clicked, open modal
        event.stopPropagation();
        const tIdx = parseInt(img.getAttribute("data-tidx"));
        const pIdx = parseInt(img.getAttribute("data-pidx"));
        if (!isNaN(tIdx) && !isNaN(pIdx) && tributes[tIdx]) {
          showModalGallery(tIdx, pIdx);
        }
      }
    };

    // Attach keydown listeners directly to images for accessibility (modal opening)
     document.querySelectorAll('.fan-img').forEach(img => {
         img.onkeydown = function(e) {
             if (e.key === 'Enter' || e.key === ' ') {
                 e.preventDefault();
                 img.click(); // Trigger the delegated click handler to open modal
             }
         }
         // REMOVED hover listener attachments
         // img.removeEventListener('mouseenter', handleFanMouseEnter);
         // img.removeEventListener('mouseleave', handleFanMouseLeave);
         // img.addEventListener('mouseenter', handleFanMouseEnter);
         // img.addEventListener('mouseleave', handleFanMouseLeave);
     });
  }
  // REMOVED hover handler functions as they are no longer used
  // function handleFanMouseEnter() { this.classList.add('fan-expanded'); }
  // function handleFanMouseLeave() { this.classList.remove('fan-expanded'); }
  // --->>> END MODIFIED attachCardEventListeners <<<---


  // --->>> MODIFIED setupCardAnimations to remove fan animation <<<---
  function setupCardAnimations() {
    if ('IntersectionObserver' in window) {

        // REMOVED IntersectionObserver for .fan-img
        /*
        document.querySelectorAll('.fan-img').forEach(img => {
            img.classList.remove('fan-anim', 'fan-pop');
            const observer = new IntersectionObserver((entries, observerInstance) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        img.classList.add('fan-pop');
                        setTimeout(() => img.classList.remove('fan-pop'), 800);
                        observerInstance.unobserve(img);
                    }
                });
            }, { threshold: 0.5 });
            observer.observe(img);
        });
        */

        // Keep IntersectionObserver for .tribute-card animation
        document.querySelectorAll('.tribute-card').forEach(card => {
            card.classList.remove('card-mobile-anim');
            const observer = new IntersectionObserver((entries, observerInstance) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        card.classList.add('card-mobile-anim');
                        setTimeout(() => card.classList.remove('card-mobile-anim'), 700);
                        observerInstance.unobserve(card);
                    }
                });
            }, { threshold: 0.42 });
            observer.observe(card);
        });
    }
  }
  // --->>> END MODIFIED setupCardAnimations <<<---


  // --- MODAL GALLERY LOGIC --- (No changes needed here)
  let modalTributeIdx = 0, modalPhotoIdx = 0;
  function showModalGallery(tributeIdx, photoIdx) {
    if (!tributes[tributeIdx]) return;
    modalTributeIdx = tributeIdx;
    modalPhotoIdx = photoIdx;
    renderModalImage();
    document.getElementById("galleryModal").classList.remove("hidden");
    document.body.style.overflow = 'hidden';
  }
  function renderModalImage() {
    let t = tributes[modalTributeIdx];
    let photos = Array.isArray(t.photos) ? t.photos : [];
    let currentPhotoSrc = photos[modalPhotoIdx];
    if (typeof currentPhotoSrc !== 'string' || !currentPhotoSrc) {
      closeModalGallery(); return;
    }
    document.getElementById('modalImg').src = currentPhotoSrc;
    document.getElementById('galleryCaption').textContent = `${t.from || "Anonymous"}: ${modalPhotoIdx + 1} / ${photos.length}`;
    document.getElementById('prevImgBtn').classList.toggle('hidden', modalPhotoIdx === 0);
    document.getElementById('nextImgBtn').classList.toggle('hidden', modalPhotoIdx >= photos.length - 1);
  }
  function closeModalGallery() {
    document.getElementById("galleryModal").classList.add("hidden");
    document.getElementById('modalImg').src = '';
    document.body.style.overflow = '';
  }

  // --- CONFETTI LOGIC --- (No changes needed here)
  function showConfetti() {
    const confettiBox = document.getElementById('confettiBox');
    confettiBox.style.display = 'flex';
    confettiBox.innerHTML = '';
    const colors = ['#fee49e','#fff44f','#60b5fa','#e57373','#a3e635','#68e1c9','#fdb253','#bb57df','#f9bbd0'];
    let n = 20 + Math.floor(8 * Math.random());
    for (let i = 0; i < n; i++) {
      let dot = document.createElement('span');
      dot.className = 'confetti__dot';
      dot.style.background = colors[Math.floor(Math.random() * colors.length)];
      let left = 4 + 92 * Math.random();
      dot.style.left = left + '%';
      dot.style.top = (5 + Math.random() * 1.6) + '%';
      dot.style.animationDelay = (Math.random() * 0.7).toFixed(2) + 's';
      dot.style.opacity = (0.65 + 0.33 * Math.random()).toFixed(2);
      confettiBox.appendChild(dot);
    }
    setTimeout(() => { confettiBox.style.display = 'none'; confettiBox.innerHTML = ''; }, 1900);
  }

  // --- INITIALIZE & EVENTS --- (No changes needed here)
  document.addEventListener("DOMContentLoaded", function() {
    fetchAndRenderTributes();
    try {
      const tributeForm = document.getElementById('tributeForm');
      if (tributeForm) { tributeForm.onsubmit = handleFormSubmit; }
      const cancelBtn = document.getElementById('cancelEditBtn');
      if (cancelBtn) { cancelBtn.onclick = resetForm; }
      const closeModalBtn = document.getElementById('closeModalBtn');
      if (closeModalBtn) { closeModalBtn.onclick = closeModalGallery; }
      const modalBG = document.getElementById('modalBG');
      if (modalBG) { modalBG.onclick = closeModalGallery; }
      const prevImgBtn = document.getElementById('prevImgBtn');
      if (prevImgBtn) {
        prevImgBtn.onclick = function(e) {
          e.stopPropagation(); if (modalPhotoIdx > 0) { modalPhotoIdx--; renderModalImage(); }
        };
      }
      const nextImgBtn = document.getElementById('nextImgBtn');
      if (nextImgBtn) {
        nextImgBtn.onclick = function(e) {
          e.stopPropagation();
          let t = tributes[modalTributeIdx];
          let photos = Array.isArray(t.photos) ? t.photos : [];
          if (modalPhotoIdx < photos.length - 1) { modalPhotoIdx++; renderModalImage(); }
        };
      }
    } catch (error) {}
    window.addEventListener("keydown", function(e) {
      const modal = document.getElementById("galleryModal");
      if (!modal || modal.classList.contains("hidden")) return;
      if (e.key === "ArrowLeft") { document.getElementById('prevImgBtn')?.click(); }
      else if (e.key === "ArrowRight") { document.getElementById('nextImgBtn')?.click(); }
      else if (e.key === "Escape") { closeModalGallery(); }
    });
  });
</script>
</body>
</html>



