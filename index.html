<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Illustrated Retiring Teacher Tribute Board - Mdm Teh</title> <!-- Changed Title -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind CSS via jsdelivr -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome 6.5.2 via jsdelivr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">
  <!-- Google Fonts: Indie Flower, Quicksand & Montserrat -->
  <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Quicksand:wght@400;500;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #fff5f7 0%, #fef7fa 100%);
      color: #546e7a;
      letter-spacing: 0.02em;
    }

    h1, h2, h3, .script-font {
      font-family: 'Indie Flower', cursive;
    }

    /* Card base style */
    .tribute-card {
      position: relative;
      box-shadow: 0 10px 25px rgba(149, 157, 165, 0.1);
      border-radius: 1.8rem;
      padding: 1.9rem 1.6rem 1.2rem 1.6rem;
      transition:
        /* Keep hover transitions */
        transform 0.24s cubic-bezier(.24,1.46,.54,1.07),
        box-shadow 0.19s;
      margin-bottom: 0.7rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(5px);
    }

    /* --- ADDED: Hide Edit/Delete Buttons and Date --- */
    .tribute-card .absolute.right-3.top-3 {
        display: none !important;
    }
    .tribute-card .absolute.bottom-3 {
        display: none !important;
    }

    .tribute-card:hover { /* Removed card-mobile-anim here, apply animation on load */
      transform: translateY(-12px) scale(1.04) rotate(-1.6deg);
      z-index: 10;
      box-shadow: 0 20px 40px rgba(114, 124, 245, 0.15), 0 2px 10px rgba(122, 122, 216, 0.1);
    }

    /* --- Fan image stack --- */
    .fan-stack { /* ... keep existing styles ... */
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      min-height: 112px;
      width: 176px;
      position: relative;
      margin: 0 auto 1.2rem auto;
      pointer-events: none;
      z-index: 1;
    }
    .fan-img { /* ... keep existing styles ... */
      width: 96px;
      height: 96px;
      object-fit: cover;
      border-radius: 1.12rem;
      box-shadow: 0 8px 20px rgba(116, 185, 255, 0.2);
      transform-origin: 50% 80%;
      position: absolute;
      background: #f9fafb;
      border: 2.5px solid #fff;
      z-index: 1;
      cursor: pointer;
      pointer-events: auto;
      filter: brightness(1) saturate(1.02);
    }

    /* Floating celebration elements */
    .floating-celebrate { /* ... keep existing styles ... */
      position: absolute;
      font-size: 1.23rem;
      opacity: 0.17;
      pointer-events: none;
      animation: floatCelebrate 9.2s linear infinite;
      z-index: 0;
    }
    @keyframes floatCelebrate { /* ... keep existing ... */ }

    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {width: 7px;}
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cfd8dc; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #eceff1; }

    /* Remove num arrows */
    input::-webkit-inner-spin-button, input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }

    html, body { overflow: initial !important; box-sizing: border-box; width: 100%; }

    /* Form styling */
    .form-container { /* ... keep existing styles ... */
      background: linear-gradient(to right, #fdf5f7, #fef9fa);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 8px 32px rgba(224, 199, 210, 0.1);
    }
    input, textarea { /* ... keep existing styles ... */
        transition: all 0.2s;
        border: 1px solid #f0e3e8 !important;
    }
    input:focus, textarea:focus { /* ... keep existing styles ... */
        border-color: #ffbbd0 !important;
        box-shadow: 0 0 0 3px rgba(255, 187, 208, 0.25) !important;
    }

    /* Button styles */
    .btn-gradient { /* ... keep existing styles ... */
      background: linear-gradient(135deg, #f09fa8 0%, #e58392 100%);
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(229, 131, 146, 0.3);
      border: none;
    }
    .btn-gradient:hover { /* ... keep existing styles ... */
        background: linear-gradient(135deg, #f4b0b8 0%, #ec9aa6 100%);
        box-shadow: 0 6px 15px rgba(229, 131, 146, 0.4);
        transform: translateY(-2px);
    }
    .btn-gradient:active { /* ... keep existing styles ... */
        transform: translateY(1px);
        box-shadow: 0 2px 5px rgba(229, 131, 146, 0.4);
    }

    /* Confetti */
    .confetti { /* ... keep existing styles ... */ }
    .confetti__dot { /* ... keep existing styles ... */ }
    @keyframes confetti-fall { /* ... keep existing styles ... */ }

    /* Footer animations */
    .footer-party { /* ... keep existing styles ... */ }
    .cap-throw { /* ... keep existing styles ... */ }
    .cap-throw2 { /* ... keep existing styles ... */ }
    @keyframes capThrow { /* ... keep existing styles ... */ }
    @keyframes capThrow2 { /* ... keep existing styles ... */ }
    .footer-teacher { /* ... keep existing styles ... */ }
    @keyframes waveHand { /* ... keep existing styles ... */ }

    /* Print */
    @media print { /* ... keep existing ... */ }

    /* Z-index */
    .tribute-card > div:not(.fan-stack), .tribute-card > button { position: relative; z-index: 1; }
    .tribute-card > .absolute.right-3.top-3 { z-index: 2; }

    /* Aesthetics */
    .page-title { /* ... keep existing styles ... */ }
    .page-subtitle { /* ... keep existing styles ... */ }
    .highlight-text { /* ... keep existing styles ... */ }

    /* --- NEW: Fade-in Animation --- */
    .tribute-card-fade-in {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }
    .tribute-card-fade-in.is-visible {
        opacity: 1;
        transform: translateY(0);
    }
    /* --- End Fade-in --- */

  </style>
</head>
<body class="pb-10 selection:bg-pink-100">
  <!-- Floating elements -->
  <span class="floating-celebrate left-12 top-28" style="animation-delay:0.1s; color:#f09fa8;"><i class="fa-solid fa-book"></i></span>
  <span class="floating-celebrate left-1/4 top-56" style="animation-delay:1.6s; color:#ffb74d;"><i class="fa-solid fa-apple-whole"></i></span>
  <span class="floating-celebrate right-14 top-28" style="animation-delay:0.9s; color:#81c784;"><i class="fa-solid fa-seedling"></i></span>
  <span class="floating-celebrate left-1/3 top-44" style="animation-delay:2.1s; color:#ce93d8;"><i class="fa-solid fa-flower"></i></span>
  <span class="floating-celebrate right-1/4 top-56" style="animation-delay:1.2s; color:#ef9a9a;"><i class="fa-solid fa-star"></i></span>
  <span class="floating-celebrate left-3/5 top-96" style="animation-delay:2.36s; color:#4db6ac;"><i class="fa-solid fa-pencil"></i></span>
  <span class="floating-celebrate left-2/3 top-20" style="animation-delay:0.5s; color:#ffd54f;"><i class="fa-solid fa-bell"></i></span>

  <div class="max-w-5xl mx-auto mt-12 px-4">
    <!-- Title & Description -->
    <div class="text-center mb-8">
      <h1 class="page-title mb-3 script-font"> ðŸŒ¼ Happy Retirement, Mdm Teh! </h1>
      <p class="page-subtitle script-font">
        A wonderful teacher leaves a mark on hearts forever.<br>
        <span class="highlight-text">Share your words, memories & photos below!</span>
      </p>
    </div>

    <!-- Add/Edit Tribute Form -->
    <form id="tributeForm" class="mb-10 form-container py-6 px-5 shadow-lg flex flex-wrap items-center justify-between">
      <input type="hidden" id="editIndex" value="">
      <div class="flex flex-col w-full md:w-1/4 mb-3 md:mb-0 md:pr-3">
        <label for="fromName" class="text-pink-500 font-semibold mb-1">Your Name</label>
        <input id="fromName" name="fromName" type="text" class="rounded-xl px-3 py-2 focus:outline-none" maxlength="32" required placeholder="E.g. Alicia (Class of 2010)">
      </div>
      <div class="flex flex-col w-full md:w-1/2 md:px-2 mb-3 md:mb-0">
        <label for="message" class="text-pink-500 font-semibold mb-1">Message</label>
        <textarea id="message" name="message" rows="2" class="rounded-xl px-3 py-2 focus:outline-none" maxlength="1500" required placeholder="Write your message..."></textarea>
      </div>
      <div class="flex flex-col w-full md:w-1/6 md:pl-2 mb-3 md:mb-0">
        <label for="photos" class="text-pink-500 font-semibold mb-1"> Photos<br> <span class="text-xs font-normal text-gray-400">(up to 4, max 20MB each)</span> </label>
        <input id="photos" name="photos" type="file" multiple accept="image/*" class="border rounded-xl py-2 px-2 text-xs bg-pink-50 border-pink-100">
      </div>
      <div class="w-full md:w-auto flex items-end justify-start md:justify-end mt-3 md:mt-0">
        <button id="submitBtn" type="submit" class="btn-gradient font-bold py-2.5 px-7 text-white rounded-xl focus:outline-none transition duration-150">
          <i class="fa-solid fa-paper-plane mr-1"></i>
          <span id="submitBtnText">Share</span>
        </button>
        <button type="button" id="cancelEditBtn" class="ml-2 hidden px-4 py-2 rounded-xl bg-gray-200 text-gray-600 font-semibold hover:bg-gray-300 focus:outline-none transition duration-100">Cancel</button>
      </div>
    </form>

    <!-- Tribute Cards Grid -->
    <div id="tributesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-10 gap-y-8 custom-scrollbar"></div>

    <!-- NEW: Loading Indicator for single card fetch -->
    <div id="singleLoadIndicator" class="text-center text-pink-400 italic mt-6 hidden h-10"> <!-- Added fixed height -->
        <i class="fa-solid fa-spinner fa-spin mr-2"></i>Loading next tribute...
    </div>

    <!-- NEW: Element to trigger loading when it becomes visible -->
    <div id="scrollTrigger" style="height: 50px;"></div> <!-- Invisible element to observe -->

    <!-- Empty State Message -->
    <div id="emptyState" class="text-center text-pink-300 italic mt-10 text-lg hidden">
      <i class="fa-solid fa-star fa-bounce mr-2"></i>No tributes yet. Be the first to post your memory!
      <p id="allLoadedMessage" class="text-sm mt-2 hidden">Looks like you've reached the end!</p>
    </div>

  </div> <!-- Closing the max-w-5xl container -->

  <!-- Modal for single photo view -->
  <div id="galleryModal" class="fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm z-50 hidden flex items-center justify-center">
    <!-- ... keep existing modal structure ... -->
    <div class="absolute inset-0 cursor-pointer" id="modalBG"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-2 flex flex-col items-center px-2 py-5 border border-pink-100">
      <button type="button" id="closeModalBtn" class="absolute right-2 top-2 text-2xl text-pink-400 hover:text-pink-600 focus:outline-none z-10" title="Close"><i class="fa-solid fa-xmark"></i></button>
      <div class="w-full flex items-center justify-center mb-3">
        <button type="button" id="prevImgBtn" class="text-xl text-pink-300 hover:text-pink-600 px-3 focus:outline-none hidden"><i class="fa-solid fa-chevron-left"></i></button>
        <div id="modalImgContainer" class="max-w-xs sm:max-w-md md:max-w-lg lg:max-w-xl rounded-xl overflow-hidden bg-gray-50 shadow">
          <img id="modalImg" src="" alt="Gallery Image" class="object-contain mx-auto" style="max-height:50vh;">
        </div>
        <button type="button" id="nextImgBtn" class="text-xl text-pink-300 hover:text-pink-600 px-3 focus:outline-none hidden"><i class="fa-solid fa-chevron-right"></i></button>
      </div>
      <div id="galleryCaption" class="text-center text-sm mt-2 mb-2 text-gray-500"></div>
    </div>
  </div>

  <!-- Animated Celebration Footer -->
  <footer class="footer-party w-full text-center mt-10 relative text-base pb-1 select-none">
    <!-- ... keep existing footer structure ... -->
     <div class="cap-throw"><i class="fa-solid fa-graduation-cap text-pink-400 text-2xl"></i></div>
     <div class="cap-throw cap-throw2"><i class="fa-solid fa-graduation-cap text-amber-400 text-2xl"></i></div>
     <span class="footer-teacher"> <svg width="56" height="70" viewBox="0 0 56 70" fill="none"><ellipse cx="28" cy="63" rx="25" ry="6" fill="#ffe0b2"/><circle cx="28" cy="34" r="20" fill="#fff"/><ellipse cx="28" cy="43.5" rx="9.5" ry="7.5" fill="#f8bbd0"/><ellipse cx="28" cy="31" rx="13" ry="14" fill="#febc97"/><ellipse cx="23" cy="23" rx="3" ry="2" fill="#624338"/><ellipse cx="33" cy="23" rx="3" ry="2" fill="#624338"/><rect x="18" y="38" width="20" height="4" rx="2" fill="#e57373"/><rect x="25" y="49" width="6" height="18" rx="3" fill="#90caf9"/><ellipse cx="45" cy="40" rx="4" ry="4.5" fill="#febc97" style="transform-origin:45px 40px"/></svg> </span>
     <span class="block font-semibold pt-10 pb-1 script-font" style="font-size:1.23rem;color:#e58392;text-shadow:0 1px 5px #fce8ffa8;"> ðŸŽ‰ With heartfelt wishes for your next amazing chapter! ðŸŽ‰ </span>
     <span class="block text-gray-500 pb-1" style="font-size:1rem;"> Made with <i class="fa-solid fa-heart text-pink-400"></i> by everyone who is grateful for you. </span>
  </footer>

  <!-- Confetti effect container -->
  <div id="confettiBox" class="confetti" style="pointer-events: none; display:none;"></div>

<!-- ======================================================== -->
<!--                  START JAVASCRIPT                      -->
<!-- ======================================================== -->
<script>
  // --- STATE ---
  let tributes = []; // Holds *all loaded* tribute data for modal/editing/state reference
  let editingTributeId = null;
  // --- SINGLE LOAD STATE ---
  let nextPageToFetch = 1; // Tracks the *page number* for the next tribute (pageSize=1)
  let isLoading = false; // Prevent multiple simultaneous loads
  let allTributesLoaded = false; // Flag when no more tributes are available

  // --- CONSTANTS ---
  const cardDateIcons = ['fa-flower','fa-apple-whole','fa-star','fa-heart','fa-seedling','fa-book'];
  const CARD_GRADIENT_PAIRS = [
    ['#fef6f8', '#fdf3f6'], ['#fef9f9', '#fff7f9'], ['#fdf6ff', '#fef9fd'],
    ['#fff9fa', '#fdf8fe'], ['#fff9f9', '#fef9f7'], ['#fbfdff', '#fdfcfb'],
    ['#fdf9ff', '#fffaf9']
  ];
  const patternColors = {
    light: 'rgba(255, 255, 255, 0.35)', dark: 'rgba(229, 131, 146, 0.06)', accent: 'rgba(206, 147, 216, 0.05)'
  };

  // --- UTILITY FUNCTIONS ---
  function hexToRgb(hex) { let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null; }
    function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      '&': '&',
      '<': '<',
      '>': '>',
      '"': '"',
      "'": '&#39;'
    }[s]));
  }
  function formatDateString(dbDateString) {
    if (!dbDateString || typeof dbDateString !== 'string') return '';
    try {
      const isoFriendlyString = dbDateString.replace(' ', 'T').replace(' UTC', 'Z');
      const date = new Date(isoFriendlyString);
      if (isNaN(date.getTime())) { console.warn("Could not parse date:", dbDateString); return 'Date unavailable'; }
      return date.toLocaleDateString("en-US", { month: 'short', day: 'numeric', year: 'numeric' });
    } catch (e) { console.error("Error formatting date:", dbDateString, e); return ''; }
  }

  // --- RENDERING LOGIC ---

  // Appends a SINGLE tribute card and applies fade-in
  function renderSingleTribute(tribute) {
      const grid = document.getElementById("tributesGrid");
      const emptyState = document.getElementById('emptyState');
      if (!grid || !emptyState) return null;

      emptyState.classList.add('hidden'); // Hide empty state if we're adding a card

      // Check for duplicates just in case
      if (tributes.some(existing => existing.id === tribute.id)) {
          console.warn("Duplicate tribute ID detected, skipping render:", tribute.id);
          return null; // Indicate skip
      }
      tributes.push(tribute);

      const cardIndex = tributes.length - 1;
      const cardHtml = renderTributeCard(tribute, cardIndex);
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = cardHtml.trim();
      const cardElement = tempDiv.firstChild;

      if (!cardElement) return null;

      // Initial state for animation is set by the class in renderTributeCard
      // cardElement.classList.add('tribute-card-fade-in'); // Already added in renderTributeCard

      grid.appendChild(cardElement);

      // Trigger the fade-in animation
      requestAnimationFrame(() => {
          setTimeout(() => { cardElement.classList.add('is-visible'); }, 50);
      });

      return cardElement; // Return the added element
  }

  // Renders the fan gallery part of a card
  function renderFanGallery(tribute, tributeIdx) {
    const photoArray = Array.isArray(tribute.photos) ? tribute.photos : [];
    if (!photoArray.length) return `<div class="fan-stack mb-1"></div>`;
    let imgMarkup = "";
    const numPhotos = Math.min(photoArray.length, 4);
    const spreadAngles = (numPhotos === 1) ? [0] : (numPhotos === 2) ? [-10, 10] : (numPhotos === 3) ? [-15, 0, 15] : [-18, -6, 6, 18];
    const horizontalShiftBase = (numPhotos > 1) ? (numPhotos - 1) * 20 : 0;
    for (let i = 0; i < numPhotos; i++) {
      if (typeof photoArray[i] !== 'string' || (!photoArray[i].startsWith('data:image') && !photoArray[i].startsWith('http'))) { console.warn(`Invalid photo data at index ${i} for tribute ${tribute.id}`); continue; }
      const angle = spreadAngles[i];
      const translateX = (numPhotos > 1) ? (i * 40) - horizontalShiftBase : 0;
      const zIndex = numPhotos - i;
      imgMarkup += ` <img src="${escapeHtml(photoArray[i])}" class="fan-img" data-tidx="${tributeIdx}" data-pidx="${i}" tabindex="0" style="transform: rotate(${angle}deg) translateX(${translateX}px); z-index: ${zIndex};" alt="Tribute Photo ${i + 1} from ${escapeHtml(tribute.from || 'Anonymous')}" loading="lazy"> `;
    }
    return `<div class="fan-stack mb-1">${imgMarkup}</div>`;
  }

  // Renders a single tribute card HTML string (includes fade-in class)
  function renderTributeCard(tribute, idx) {
      const tributeId = tribute.id;
      const fromName = tribute.from || "Anonymous";
      const message = tribute.msg || "";
      const date = tribute.date || "";
      const gradientPair = CARD_GRADIENT_PAIRS[idx % CARD_GRADIENT_PAIRS.length];
      const gradientColor1 = gradientPair[0], gradientColor2 = gradientPair[1];
      const cardBaseGradient = `linear-gradient(135deg, ${gradientColor1} 0%, ${gradientColor2} 100%)`;
      let cardPatternStyle = '', cardPatternBgImage = ''; const cardPatternType = idx % 5; const patternColorDark = patternColors.dark, patternColorLight = patternColors.light;
      switch (cardPatternType) { /* ... cases for patterns ... */
        case 0: cardPatternBgImage = `radial-gradient(${patternColorDark} 3%, transparent 4%), radial-gradient(${patternColorDark} 3%, transparent 4%)`; cardPatternStyle = `background-size: 40px 40px; background-position: 0 0, 20px 20px;`; break;
        case 1: cardPatternBgImage = `linear-gradient(135deg, ${patternColorDark} 1%, transparent 2%, transparent 50%, ${patternColorDark} 50%, ${patternColorDark} 51%, transparent 52%, transparent 100%)`; cardPatternStyle = `background-size: 40px 40px;`; break;
        case 2: cardPatternBgImage = `linear-gradient(45deg, ${patternColorLight} 10%, transparent 12%, transparent 90%, ${patternColorLight} 91%, ${patternColorLight}), linear-gradient(135deg, ${patternColorLight} 10%, transparent 12%, transparent 90%, ${patternColorLight} 91%, ${patternColorLight})`; cardPatternStyle = `background-size: 38px 38px;`; break;
        case 3: const waveSvgColor = patternColors.accent.replace('rgba', 'rgba').replace(/[\d\.]+\)$/, '0.07)'); const svgWaveCard = `<svg width='120' height='15' xmlns='http://www.w3.org/2000/svg'><path d='M0 6 Q 30 12, 60 6 T 120 6' fill='none' stroke='${encodeURIComponent(waveSvgColor)}' stroke-width='0.8'/></svg>`; cardPatternBgImage = `url("data:image/svg+xml,${encodeURIComponent(svgWaveCard)}")`; cardPatternStyle = `background-size: 60px; background-repeat: repeat;`; break;
        case 4: cardPatternBgImage = `radial-gradient(${patternColorDark} 0.8px, transparent 0), radial-gradient(${patternColorDark} 0.8px, transparent 0)`; cardPatternStyle = `background-size: 12px 12px; background-position: 0 0, 6px 6px;`; break;
      }
      const cardBackgroundStyle = `background: ${cardPatternBgImage ? cardPatternBgImage + ',' : ''} ${cardBaseGradient}; ${cardPatternStyle}`;
      const dateIconClass = cardDateIcons[idx % cardDateIcons.length];

      // Main card div includes 'tribute-card-fade-in'
      return `
      <div class="tribute-card tribute-card-fade-in relative" data-cardidx="${idx}" data-id="${tributeId}" style="${cardBackgroundStyle}">
          <div class="absolute right-3 top-3 flex space-x-2" style="z-index: 5;">
              <button title="Edit Tribute" aria-label="Edit Tribute by ${escapeHtml(fromName)}" data-act="edit" data-id="${tributeId}" class="text-pink-400 hover:text-amber-500 bg-white rounded-full shadow border border-pink-100 px-2 py-1 focus:outline-none transition focus:ring-2 focus:ring-amber-300"> <i class="fa-solid fa-pen fa-xs"></i> </button>
              <button title="Delete Tribute" aria-label="Delete Tribute by ${escapeHtml(fromName)}" data-act="delete" data-id="${tributeId}" class="text-pink-400 hover:text-red-500 bg-white rounded-full shadow border border-pink-100 px-2 py-1 focus:outline-none transition focus:ring-2 focus:ring-red-300"> <i class="fa-solid fa-trash fa-xs"></i> </button>
          </div>
          ${renderFanGallery(tribute, idx)}
          <div class="text-pink-600 font-bold mb-2 text-center" style="font-family:'Indie Flower',cursive; font-size: 1.2rem;"> ${escapeHtml(fromName)} </div>
          <div class="text-gray-700 mb-3 text-center px-1 text-sm" style="font-family:'Quicksand',sans-serif; max-height: 100px; overflow-y: auto;"> ${escapeHtml(message).replace(/\n/g, "<br>")} </div>
          <div class="text-xs text-pink-400 absolute bottom-3 left-1/2 transform -translate-x-1/2 flex items-center gap-1"> <i class="fa-solid ${dateIconClass} fa-xs"></i> <span>${formatDateString(date)}</span> </div>
      </div>
      `;
  }

  // --- API INTERACTIONS ---

  // Fetches the NEXT SINGLE tribute
  async function loadNextTribute() {
      const loadingIndicator = document.getElementById('singleLoadIndicator');
      const emptyState = document.getElementById('emptyState');
      const allLoadedMsg = document.getElementById('allLoadedMessage');

      if (isLoading || allTributesLoaded) { console.log("Skipping loadNextTribute:", { isLoading, allTributesLoaded }); return; }
      isLoading = true;
      if (loadingIndicator) loadingIndicator.classList.remove('hidden');
      console.log(`Fetching next tribute (page ${nextPageToFetch})...`);

      try {
          const response = await fetch(`/.netlify/functions/get-tributes?page=${nextPageToFetch}&pageSize=1`);
          if (!response.ok) { let errorMsg = `HTTP error! status: ${response.status}`; try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (e) {} throw new Error(errorMsg); }
          const data = await response.json();

          if (!data || !Array.isArray(data.tributes) || data.tributes.length === 0) {
              console.log("All tributes loaded.");
              allTributesLoaded = true;
              if (tributes.length === 0) { emptyState.classList.remove('hidden'); allLoadedMsg.classList.add('hidden'); }
              else { emptyState.classList.add('hidden'); allLoadedMsg?.classList.remove('hidden'); }
          } else {
              const tribute = data.tributes[0];
              renderSingleTribute(tribute);
              nextPageToFetch++;
          }
      } catch (error) {
          console.error("Could not load next tribute:", error);
          if (loadingIndicator) loadingIndicator.innerText = "Error loading. Try scrolling again.";
      } finally {
          isLoading = false;
          if (loadingIndicator) { setTimeout(() => { loadingIndicator.classList.add('hidden'); loadingIndicator.innerText = "Loading next tribute..."; }, 300); }
      }
  }

  // --- Modified Add/Edit/Delete Handling ---
  async function resetAndReloadAll() {
      console.log("Resetting and reloading all tributes...");
      const grid = document.getElementById("tributesGrid");
      const emptyState = document.getElementById('emptyState');
      const allLoadedMsg = document.getElementById('allLoadedMessage');
      if (grid) grid.innerHTML = '';
      tributes = []; nextPageToFetch = 1; isLoading = false; allTributesLoaded = false;
      if(emptyState) emptyState.classList.add('hidden'); if(allLoadedMsg) allLoadedMsg.classList.add('hidden');
      document.getElementById('singleLoadIndicator')?.classList.add('hidden');
      await loadNextTribute();
      setupScrollObserver(); // Re-observe after reload
  }

  // Calls resetAndReloadAll on success
  async function submitTribute(tributeData, idToUpdate = null) {
      const isUpdating = idToUpdate !== null && !isNaN(parseInt(idToUpdate, 10));
      const endpoint = isUpdating ? '/.netlify/functions/update-tribute' : '/.netlify/functions/add-tribute';
      const method = isUpdating ? 'PUT' : 'POST';
      const payload = { from: tributeData.from, msg: tributeData.msg, photos: tributeData.photos }; // photos are base64
      if (isUpdating) { payload.id = parseInt(idToUpdate, 10); }
      console.log(`Submitting tribute (${isUpdating ? 'Update ID: '+payload.id : 'New'})`);
      try {
          const response = await fetch(endpoint, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          if (!response.ok) { throw new Error(`HTTP Error ${response.status}`); }
          console.log(`Tribute ${isUpdating ? 'updated' : 'added'} successfully.`);
          showConfetti();
          await resetAndReloadAll(); // Reload everything
          return true;
      } catch (error) { console.error(`Error ${isUpdating ? 'updating' : 'sharing'} tribute:`, error); alert(`Error: ${error.message}`); return false; }
  }

  // Calls resetAndReloadAll on success
  async function deleteTribute(tributeId) {
      const idToDelete = parseInt(tributeId, 10);
      if (isNaN(idToDelete)) return false;
      if (!confirm('Are you sure you want to delete this tribute? This cannot be undone.')) return false;
      console.log("Attempting to delete tribute ID:", idToDelete);
      try {
          const response = await fetch('/.netlify/functions/delete-tribute', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: idToDelete }) });
          if (!response.ok) { throw new Error(`HTTP Error ${response.status}`); }
          console.log("Tribute deleted successfully:", idToDelete);
          await resetAndReloadAll(); // Reload everything
          return true;
      } catch (error) { console.error("Error deleting tribute:", error); alert(`Error: ${error.message}`); return false; }
  }

  // --- FORM HANDLING (Includes Temporary Base64 Photo Processing) ---
  async function filesToDataURLs_Temporary(fileList) {
    const MAX_FILES = 4, MAX_SIZE_MB = 20;
    const filesToProcess = Array.from(fileList).slice(0, MAX_FILES);
    const readerPromises = filesToProcess.map(file => {
      return new Promise((resolve, reject) => {
        if (!file.type.startsWith('image/')) return resolve(null);
        if (file.size > MAX_SIZE_MB * 1024 * 1024) { alert(`File "${file.name}" > ${MAX_SIZE_MB}MB.`); return resolve(null); }
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    });
     const results = await Promise.allSettled(readerPromises);
     return results.filter(r => r.status === 'fulfilled' && r.value !== null).map(r => r.value);
  }

  async function handleFormSubmit(e) {
      e.preventDefault();
      const submitBtn = document.getElementById('submitBtn'), submitBtnText = document.getElementById('submitBtnText'), fileInput = document.getElementById('photos');
      if (!submitBtn || !submitBtnText || !fileInput) return;
      if (isLoading) { alert("Please wait for loading."); return; }
      submitBtn.disabled = true;
      const originalBtnText = editingTributeId ? "Update" : "Share";
      let actionText = editingTributeId ? 'Updating...' : 'Sharing...';
      let photos = [];
      try {
          if (fileInput.files.length > 0 && fileInput.files.length <= 4) {
              actionText = editingTributeId ? 'Processing & Updating...' : 'Processing & Sharing...';
              submitBtnText.textContent = actionText;
              photos = await filesToDataURLs_Temporary(fileInput.files);
          } else if (fileInput.files.length > 4) { throw new Error("Too many photos selected (max 4)."); }
          submitBtnText.textContent = actionText;

          const from = document.getElementById('fromName').value.trim() || "Anonymous";
          const msg = document.getElementById('message').value.trim();
          if (!msg) { throw new Error("Message cannot be empty."); }
          if (msg.length > 1500) { throw new Error("Message exceeds 1500 characters."); }

          const tributeData = { from, msg, photos }; // Photos are base64
          const idToUpdate = editingTributeId ? parseInt(editingTributeId, 10) : null;
          if (editingTributeId && isNaN(idToUpdate)) { throw new Error("Invalid tribute ID for update."); }

          const success = await submitTribute(tributeData, idToUpdate);
          if (success) { resetForm(); } else { submitBtn.disabled = false; submitBtnText.textContent = originalBtnText; }
      } catch (error) { console.error("Error handling form submit:", error); alert(error.message); submitBtn.disabled = false; submitBtnText.textContent = originalBtnText; }
  }

  // resetForm
  function resetForm() {
    const form = document.getElementById('tributeForm'); const submitBtnText = document.getElementById('submitBtnText'); const cancelBtn = document.getElementById('cancelEditBtn'); const submitBtn = document.getElementById('submitBtn');
    if (form) form.reset(); if (submitBtnText) submitBtnText.textContent = "Share"; if (cancelBtn) cancelBtn.classList.add('hidden'); if (submitBtn) submitBtn.disabled = false;
    editingTributeId = null; console.log("Form reset and editing cancelled.");
  }

  // loadEditForm
  function loadEditForm(tributeId) {
    const idToLoad = parseInt(tributeId, 10); if (isNaN(idToLoad)) return;
    const tributeToEdit = tributes.find(t => t.id === idToLoad);
    if (!tributeToEdit) { alert("Could not find tribute data to edit. It might be on a page not yet loaded or deleted."); return; }
    console.log("Loading tribute for editing:", tributeToEdit);
    const nameInput = document.getElementById('fromName'); const messageInput = document.getElementById('message'); const fileInput = document.getElementById('photos');
    if (nameInput) nameInput.value = tributeToEdit.from || ''; if (messageInput) messageInput.value = tributeToEdit.msg || ''; if (fileInput) fileInput.value = ''; // Clear file input
    editingTributeId = idToLoad;
    const submitBtnText = document.getElementById('submitBtnText'); const cancelBtn = document.getElementById('cancelEditBtn');
    if (submitBtnText) submitBtnText.textContent = "Update"; if (cancelBtn) cancelBtn.classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // --- UI INTERACTIONS ---

  // Event delegation for grid clicks (edit/delete/photo)
  function attachGridEventListeners() {
    const grid = document.getElementById('tributesGrid'); if (!grid) return;
    grid.onclick = function handleGridClick(event) {
      const target = event.target;
      const actionButton = target.closest('button[data-act]'); const photoImage = target.closest('.fan-img');
      if (actionButton) { event.stopPropagation(); const action = actionButton.getAttribute('data-act'); const id = actionButton.getAttribute('data-id'); if (!id) return; if (action === 'edit') loadEditForm(id); else if (action === 'delete') deleteTribute(id); return; }
      if (photoImage) { event.stopPropagation(); const cardElement = photoImage.closest('.tribute-card'); const tributeIndex = cardElement ? parseInt(cardElement.getAttribute("data-cardidx"), 10) : NaN; const photoIndex = parseInt(photoImage.getAttribute("data-pidx"), 10); if (!isNaN(tributeIndex) && !isNaN(photoIndex) && tributes[tributeIndex]) { showModalGallery(tributeIndex, photoIndex); } else { console.warn("Could not determine indices for modal.", { tributeIndex, photoIndex }); } return; }
    };
     grid.onkeydown = function handleGridKeyDown(event) { if ((event.key === 'Enter' || event.key === ' ') && event.target.matches('.fan-img')) { event.preventDefault(); event.target.click(); } };
    console.log("Event listeners attached to tributesGrid.");
  }

  // --- Modal Gallery Logic ---
  let modalTributeIdx = 0, modalPhotoIdx = 0;
  function showModalGallery(tributeIdx, photoIdx) {
    const modal = document.getElementById("galleryModal");
    if (!modal || typeof tributeIdx !== 'number' || tributeIdx < 0 || tributeIdx >= tributes.length || !tributes[tributeIdx]) { console.error("Invalid data for modal:", tributeIdx); return; }
    const tribute = tributes[tributeIdx];
    if (!Array.isArray(tribute.photos) || typeof photoIdx !== 'number' || photoIdx < 0 || photoIdx >= tribute.photos.length) { console.error("Invalid photo index for modal:", photoIdx, tribute.photos); return; }
    modalTributeIdx = tributeIdx; modalPhotoIdx = photoIdx;
    renderModalImage();
    modal.classList.remove("hidden"); modal.focus(); document.body.style.overflow = 'hidden';
  }
  function renderModalImage() {
    const modalImg = document.getElementById('modalImg'), caption = document.getElementById('galleryCaption'), prevBtn = document.getElementById('prevImgBtn'), nextBtn = document.getElementById('nextImgBtn');
    if (!modalImg || !caption || !prevBtn || !nextBtn) { closeModalGallery(); return; }
    const tribute = tributes[modalTributeIdx]; const photos = Array.isArray(tribute.photos) ? tribute.photos : []; const currentPhotoSrc = photos[modalPhotoIdx];
    if (typeof currentPhotoSrc !== 'string' || (!currentPhotoSrc.startsWith('data:image') && !currentPhotoSrc.startsWith('http'))) { console.error(`Invalid image source at index ${modalPhotoIdx}`); modalImg.alt = "Invalid image"; modalImg.src = ""; caption.textContent = "Error loading image."; prevBtn.classList.add('hidden'); nextBtn.classList.add('hidden'); return; }
    modalImg.src = currentPhotoSrc; modalImg.alt = `Photo ${modalPhotoIdx + 1} from ${escapeHtml(tribute.from || 'Anonymous')}`; caption.textContent = `${escapeHtml(tribute.from || 'Anonymous')}: Photo ${modalPhotoIdx + 1} of ${photos.length}`;
    prevBtn.classList.toggle('hidden', modalPhotoIdx === 0); nextBtn.classList.toggle('hidden', modalPhotoIdx >= photos.length - 1);
  }
  function closeModalGallery() { const modal = document.getElementById("galleryModal"), modalImg = document.getElementById('modalImg'); if (!modal) return; modal.classList.add("hidden"); if (modalImg) modalImg.src = ''; document.body.style.overflow = ''; }
  function navigateModal(direction) { if (!tributes[modalTributeIdx] || !Array.isArray(tributes[modalTributeIdx].photos)) return; const photos = tributes[modalTributeIdx].photos; if (direction === 'prev' && modalPhotoIdx > 0) { modalPhotoIdx--; renderModalImage(); } else if (direction === 'next' && modalPhotoIdx < photos.length - 1) { modalPhotoIdx++; renderModalImage(); } }

  // --- Confetti Animation ---
  function showConfetti() {
    const c = document.getElementById('confettiBox'); if (!c) return; c.style.display = 'flex'; c.innerHTML = '';
    const o = ['#f8bbd0','#f48fb1','#f06292','#ec407a','#e91e63','#d81b60','#ce93d8','#ba68c8','#ab47bc','#9c27b0','#ffccbc','#ffab91','#ff8a65','#ff7043'];
    const n = 30 + Math.floor(15 * Math.random()); for (let i = 0; i < n; i++) { let d = document.createElement('span'); d.className = 'confetti__dot'; d.style.background = o[Math.floor(Math.random() * o.length)]; d.style.left = (2 + 96 * Math.random()) + '%'; d.style.top = (-5 + Math.random() * 10) + '%'; d.style.animationDelay = (Math.random() * 0.9).toFixed(2) + 's'; d.style.opacity = (0.6 + 0.4 * Math.random()).toFixed(2); const s = 0.8 + Math.random() * 0.4; d.style.transform = `scale(${s.toFixed(2)})`; c.appendChild(d); }
    setTimeout(() => { if (c) { c.style.display = 'none'; c.innerHTML = ''; } }, 2100);
  }

  // --- Infinite Scroll Setup ---
  let observer;
  function setupScrollObserver() {
      if (observer) { observer.disconnect(); }
      const scrollTrigger = document.getElementById('scrollTrigger'); if (!scrollTrigger) return;
      const options = { root: null, rootMargin: '0px', threshold: 0.1 };
      observer = new IntersectionObserver((entries, observerInstance) => {
          entries.forEach(entry => { if (entry.isIntersecting && !isLoading && !allTributesLoaded) { loadNextTribute(); } });
      }, options);
      observer.observe(scrollTrigger); console.log("IntersectionObserver setup for infinite scroll.");
  }

  // --- INITIALIZATION & GLOBAL EVENT LISTENERS ---
  document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM fully loaded and parsed");
      attachGridEventListeners();
      try {
         const tributeForm = document.getElementById('tributeForm'); if (tributeForm) { tributeForm.onsubmit = handleFormSubmit; } else { console.warn("Tribute form not found."); }
         const cancelBtn = document.getElementById('cancelEditBtn'); if (cancelBtn) { cancelBtn.onclick = resetForm; }
         const closeModalBtn=document.getElementById('closeModalBtn');if(closeModalBtn){closeModalBtn.onclick=closeModalGallery;}else { console.warn("Close modal button not found."); }
         const modalBG=document.getElementById('modalBG');if(modalBG){modalBG.onclick=closeModalGallery;} else { console.warn("Modal background not found."); }
         const prevImgBtn=document.getElementById('prevImgBtn');if(prevImgBtn){prevImgBtn.onclick=(e)=>{e.stopPropagation();navigateModal('prev');};} else { console.warn("Prev image button not found."); }
         const nextImgBtn=document.getElementById('nextImgBtn');if(nextImgBtn){nextImgBtn.onclick=(e)=>{e.stopPropagation();navigateModal('next');};} else { console.warn("Next image button not found."); }
      } catch (error) { console.error("Error attaching initial static event listeners:", error); }
      window.addEventListener("keydown", function(e) { const m=document.getElementById("galleryModal"); if (!m || m.classList.contains("hidden")) return; switch (e.key) { case "ArrowLeft": document.getElementById('prevImgBtn')?.click(); break; case "ArrowRight": document.getElementById('nextImgBtn')?.click(); break; case "Escape": closeModalGallery(); break; } });
      loadNextTribute(); // Initial load
      setupScrollObserver(); // Setup infinite scroll
      console.log("Initialization complete.");
  });
</script>
<!-- ======================================================== -->
<!--                   END JAVASCRIPT                       -->
<!-- ======================================================== -->

</body>
</html>
